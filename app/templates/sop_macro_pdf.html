<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SOP Diario — {{ persona.nombre }} ({{ fecha.strftime('%Y-%m-%d') }})</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #fafafa;
      --fg: #222;
      --muted:#666;
      --card:#ffffff;
      --line:#ddd;
      --accent:#0d6efd;
      --warn:#f0ad4e;
      --soft:#f8f9fa;
    }

    html, body{
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.45;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    body{ margin: 28px; font-size: 11pt; }
    .wrap{ max-width: 980px; margin: 0 auto; }

    /* ===== Encabezado ===== */
    .head{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: end;
      margin-bottom: 10px;
    }
    h1{ font-size: 1.35rem; margin: 0 0 4px 0; }
    .sub{ color: var(--muted); font-size: .9rem; }

    .meta{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      margin: 10px 0 16px;
    }
    .meta div strong{ color:#111; }

    .code-badge{
      background: var(--soft);
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 2px 8px;
      font-size: .8rem;
      margin-left: auto;
    }

    /* ===== Panel ===== */
    .panel{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      page-break-inside: avoid;
    }
    .panel-title{
      display: flex; gap: 10px; align-items: baseline; margin: 0 0 4px 0;
    }
    .panel-title h2{ font-size: 1.1rem; margin: 0; }
    .panel-meta{ color: var(--muted); font-size: .9rem; }

    /* ===== Avisos ===== */
    .observacion-critica{
      background: #fff3cd;
      border-left: 4px solid var(--warn);
      padding: 8px 12px;
      margin: 8px 0 12px 2px;
      border-radius: 6px;
      font-size: .9rem;
      color: #5c4400;
      font-style: italic;
      max-width: 90%;
      page-break-inside: avoid;
    }

    .nota-tecnica{
      background: #fff8e1;
      border-left: 4px solid #f4c542;
      padding: 8px 12px;
      margin-top: 8px;
      font-size: .9rem;
      font-style: italic;
      border-radius: 6px;
      page-break-inside: avoid;
    }

    /* ===== Listado ===== */
    ol.list{ margin: .25rem 0 0 1.2rem; padding-left: 0; }
    .list li{
      margin: 0 0 10px 0;
      padding-bottom: 10px;
      box-shadow: 0 1px 0 0 rgba(0,0,0,.06);
      list-style: decimal;
      page-break-inside: avoid;
    }
    .list li:last-child{ box-shadow: none; }

    .fr-title{
      font-size: 1.05rem;
      font-weight: 700;
      letter-spacing: .2px;
      margin-bottom: 2px;
    }

    .tiempo-box{
      background: var(--soft);
      font-size: .78rem;
      color: var(--muted);
      padding: 2px 8px;
      border-left: 3px solid var(--accent);
      border-radius: 6px;
      display: inline-block;
      margin: 4px 0 6px;
    }

    .section-line{ border-top: 1px solid #eee; margin: 8px 0; }

    /* ===== Metodología ===== */
    .metodologia{ margin-top: 6px; font-size: .9rem; }
    .metodologia strong{ font-weight: 600; }
    .metodologia ol{
      margin: 4px 0 0 1.2rem;
      padding-left: 0;
      font-size: .86rem;
    }

    /* ===== Producto / Herramientas ===== */
    .detalle-item{
      font-size: .8rem;        /* más sutil */
      color: #555;             /* un poco más tenue */
      margin: 3px 0 2px;
      line-height: 1.3;
    }

    /* ===== Tabla compacta ===== */
    table.elementos-tabla{
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 0.8rem; /* más compacto */
    }
    table.elementos-tabla th,
    table.elementos-tabla td{
      border: 1px solid #ddd;
    }
    table.elementos-tabla th{
      background: #f3f3f3;
      font-weight: 600;
      text-align: left;
      padding: 6px 8px;
    }
    table.elementos-tabla td{
      padding: 4px 6px;
      line-height: 1.25;
      vertical-align: middle;
    }
    table.elementos-tabla td.center{ text-align: center; }

    thead{ display: table-header-group; }
    tr{ page-break-inside: avoid; }

    /* ===== Footer ===== */
    .footer{
      margin-top: 20px;
      text-align: center;
      font-size: .85rem;
      color: var(--muted);
    }

    /* ===== Print ===== */
    @media print{
      body{ margin: 18mm 14mm; }
      .panel{ box-shadow: none; border-color: #ccc; }
      .page-break{ page-break-before: always; }
      a{ color: inherit; text-decoration: none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div>
        <h1>SOP Diario — Reporte por Operario</h1>
        <div class="sub">Generado para <strong>{{ persona.nombre }}</strong></div>
      </div>
      <div class="code-badge">[{{ fecha.strftime('%Y-%m-%d') }}]</div>
    </div>

    <div class="meta">
      <div><strong>Operario:</strong> {{ persona.nombre }}</div>
      <div><strong>Fecha:</strong> {{ fecha.strftime('%Y-%m-%d') }}</div>
      <div><strong>ID:</strong> {{ persona.personal_id }}</div>
    </div>

    {% if detalles and detalles|length > 0 %}
      {% for d in detalles %}
        <div class="panel">
          <div class="panel-title">
            <h2>{{ d.subarea }}</h2>
            <div class="panel-meta">({{ d.area }}) — Nivel: <strong>{{ d.nivel|capitalize }}</strong></div>
            <div class="code-badge">{{ d.sop_codigo if d.sop_codigo else 'SOP: N/D' }}</div>
          </div>

          {% if d.observacion_critica %}
            <div class="observacion-critica"><strong>Observaciones críticas:</strong> {{ d.observacion_critica }}</div>
          {% endif %}

          {% if d.fracciones and d.fracciones|length > 0 %}
            <ol class="list">
              {% for f in d.fracciones %}
                <li>
                  <div class="fr-title">{{ f.fraccion_nombre }}</div>

                  {% if f.tiempo_base %}
                    <div class="tiempo-box">Tiempo estimado: {{ f.tiempo_base }} min</div>
                  {% endif %}

                  {# Solo Metodología (sin descripción) #}
                  {% set M = f.metodologia %}
                  {% if M and M['pasos'] and M['pasos']|length > 0 %}
                    <div class="section-line"></div>
                    <div class="metodologia">
                      <strong>Metodología:</strong>
                      <ol>
                        {% for paso in M['pasos'] %}
                          <li>{{ paso['instruccion'] }}</li>
                        {% endfor %}
                      </ol>
                    </div>
                  {% endif %}

                  {% if f.elementos_tabla %}
                    <div class="section-line"></div>
                    <div>
                      <strong>Elementos:</strong>
                      <table class="elementos-tabla">
                        <thead>
                          <tr>
                            <th>Elemento</th>
                            <th>Material</th>
                            <th style="width:70px;">Cantidad</th>
                            <th>Químico</th>
                            <th>Herramienta</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for e in f.elementos_tabla %}
                            <tr>
                              <td>{{ e.nombre }}</td>
                              <td>{{ e.material }}</td>
                              <td class="center">{{ e.cantidad }}</td>
                              <td>{{ e.producto }}</td>
                              <td>{{ e.herramienta }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% endif %}

                  {% if f.producto %}
                    <p class="detalle-item"><strong>Producto:</strong> {{ f.producto }}</p>
                  {% endif %}
                  {% if f.herramienta %}
                    <p class="detalle-item"><strong>Herramientas:</strong> {{ f.herramienta }}</p>
                  {% endif %}

                  {% if f.nota_tecnica or f.observacion_critica %}
                    <div class="nota-tecnica">
                      {{ f.nota_tecnica if f.nota_tecnica else f.observacion_critica }}
                    </div>
                  {% endif %}
                </li>
              {% endfor %}
            </ol>
          {% else %}
            <p class="sub"><em>Sin fracciones para el nivel asignado.</em></p>
          {% endif %}
        </div>

        {% if not loop.last %}
          <div class="page-break"></div>
        {% endif %}
      {% endfor %}
    {% else %}
      <div class="panel">
        <p class="sub">No hay SOP asignado para este día.</p>
      </div>
    {% endif %}

    <div class="footer">LuxSOP ERP — SOP diario operativo.</div>
  </div>
</body>
</html>
