<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --fg:#222; --muted:#777; --line:#ddd; --bg:#f9f9f9;
      --blue:#0d6efd; --green:#198754; --card:#fff;
      --h:46px;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      margin:0;
      padding:2rem;
      padding-left:70px; /* ‚úÖ Espacio para burger */
      max-width:1200px;
      margin-inline:auto;
    }

    @media (max-width: 900px) {
      body {
        padding-left: 2rem; /* En m√≥vil el burger no estorba tanto */
      }
    }

    .head{
      border-bottom:1px solid var(--line);
      padding-bottom:.85rem;
      margin-bottom:14px;
    }
    h1{ margin:0; font-size:1.55rem; }
    .sub{ color:var(--muted); font-size:.95rem; margin-top:.35rem; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 1px 4px rgba(0,0,0,0.05);
      padding:16px;
    }
    .stack{ display:flex; flex-direction:column; gap:14px; }

    label{
      display:block;
      font-size:.85rem;
      font-weight:600;
      color:#333;
      margin-bottom:6px;
    }
    select{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:.55rem .8rem;
      height:var(--h);
      font-size:1rem;
      background:#fff;
    }

    .btn{
      border:none;
      border-radius:16px;
      height:var(--h);
      padding:.55rem 1.1rem;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      white-space:nowrap;
    }
    .btn-blue{ background: var(--blue); color:#fff; }
    .btn-green{ background: var(--green); color:#fff; }
    .btn:hover{ filter: brightness(.95); }

    /* ====== Card 1: selecci√≥n ====== */
    .control-grid{
      display:grid;
      grid-template-columns: 1fr 1.2fr 1.2fr 1fr auto;
      gap:14px;
      align-items:end;
    }
    .field{ display:flex; flex-direction:column; }

    @media (max-width: 980px){
      .control-grid{ grid-template-columns: 1fr; }
      .control-grid .btn{ width:100%; }
    }

    /* ====== Card 2: resultados ====== */
    .result-row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      height:var(--h);
      padding:0 .9rem;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      font-size:.98rem;
      font-weight:600;
      line-height:1;
      white-space:nowrap;
    }
    .pill strong{ font-weight:700; }
    .pill-ok{ border-color:#cde8d5; background:#eef9f0; color:#226b3d; }
    .pill-warn{ border-color:#ffe8a1; background:#fff8e1; color:#7a5b00; }

    .right-actions{
      display:flex;
      gap:10px;
      align-items:center;
      margin-left:auto;
    }
    @media (max-width: 980px){
      .result-row{ flex-direction:column; align-items:stretch; }
      .right-actions{ width:100%; }
      .right-actions .btn{ width:100%; }
    }

    /* ===== men√∫ lateral ===== */
    .burger {
      position: fixed;
      top: 16px; left: 16px;
      z-index: 1101;
      width: 40px; height: 40px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
      cursor: pointer;
      font-size: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 4px rgba(0,0,0,.06);
    }

    /* ‚úÖ Overlay con fix para Safari iOS */
    .nav-overlay{
      position:fixed; inset:0;
      z-index:1100;

      /* ‚úÖ Cerrado = neutral para Safari */
      background: transparent;

      opacity:0;
      visibility: hidden;
      pointer-events:none;

      /* ‚úÖ La opacidad baja, y la visibilidad se oculta al final */
      transition: opacity .18s ease, visibility 0s linear .18s;
    }

    .nav-overlay.is-open{
      /* ‚úÖ Abierto = s√≠ oscurece */
      background: rgba(0,0,0,.35);

      opacity:1;
      visibility: visible;
      pointer-events:auto;

      transition: opacity .18s ease;
    }

    /* ‚úÖ Top guard: franja blanca arriba para evitar tinte gris en Safari */
    .top-guard {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: env(safe-area-inset-top, 44px);
      background: #fff;
      z-index: 1103;
      pointer-events: none;
      opacity: 0;
      transition: opacity .12s ease;
    }
    .top-guard.is-on {
      opacity: 1;
    }
    .side-nav{
      position:fixed; top:0; left:0;
      height:100vh; width:300px; max-width:84vw;
      background: var(--card);
      border-right:1px solid var(--line);
      box-shadow:0 8px 30px rgba(0,0,0,.14);
      z-index:1102;
      transform: translateX(-105%);
      transition: transform .2s ease;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .side-nav.is-open{ transform: translateX(0); }
    .side-nav__head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding-bottom:10px; border-bottom:1px solid var(--line);
      margin-bottom:6px;
    }
    .side-nav__brand{ display:grid; line-height:1.1; }
    .side-nav__brand strong{ font-size:1rem; }
    .side-nav__brand span{ font-size:.78rem; color:var(--muted); }
    .side-nav__close{
      width:36px; height:36px; border-radius:10px;
      border:1px solid var(--line); background:#fff; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .side-nav__link{
      text-decoration:none; color:var(--fg);
      padding:10px 12px; border-radius:12px;
      display:flex; align-items:center; gap:10px;
      font-size:.92rem;
      font-weight:500;
    }
    .side-nav__link:hover{ background:#f3f3f3; }

    .side-nav__link-btn{
        width: 100%;
        background: transparent;
        border: none;
        text-align: left;
        cursor: pointer;
    }
    .side-nav__section{
        margin-top: 6px;
        padding-top: 10px;
        border-top: 1px solid rgba(0,0,0,.08);
        color: var(--muted);
        font-size: .75rem;
    }

    /* ===== Secci√≥n title ===== */
    .section-title{
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 .5rem 0;
      color: var(--fg);
    }
    .section-desc{
      color: var(--muted);
      font-size: .9rem;
      margin: 0 0 1rem 0;
    }

    /* ‚úÖ NUEVO: Sidebar din√°mico - bot√≥n back y transiciones */
    .side-nav__head{
      min-height:52px;
    }

    .side-nav__close,
    .side-nav__back{
      width:36px; height:36px; border-radius:10px;
      border:1px solid var(--line); background:#fff; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:18px;
      transition:background 0.2s ease;
      flex-shrink:0;
    }

    .side-nav__close:hover,
    .side-nav__back:hover{
      background:#f5f5f5;
    }

    .side-nav__link{
      background:transparent;
      border:none;
      width:100%;
      text-align:left;
      cursor:pointer;
      transition:background 0.2s ease;
    }

    .side-nav__content {
      display: flex;
      flex-direction: column;
      gap: 8px;
      opacity: 1;
      transition: opacity .15s ease;
    }

    .side-nav__content.is-transitioning {
      opacity: 0;
    }

  </style>
</head>

<body>

<!-- Men√∫ lateral -->
<button class="burger" id="navToggle" aria-label="Abrir men√∫" aria-controls="sideNav" aria-expanded="false">‚ò∞</button>
<div class="nav-overlay" id="navOverlay" aria-hidden="true"></div>

<!-- ‚úÖ Top guard: mantiene Safari blanco arriba -->
<div class="top-guard" id="topGuard" aria-hidden="true"></div>

<nav class="side-nav" id="sideNav" aria-label="Men√∫ principal">
  <div class="side-nav__head" id="navHead">
    <div class="side-nav__brand">
      <strong>LuxSOP</strong>
      <span>ERP ¬∑ Limpieza</span>
    </div>
    <button class="side-nav__close" id="navClose" aria-label="Cerrar men√∫">‚úï</button>
  </div>
  <div class="side-nav__content" id="navContent">
    <!-- Se llenar√° din√°micamente con JavaScript -->
  </div>
</nav>

<div class="head">
  <h1>SOP</h1>
  <div class="sub">
    Gestiona SOPs Regulares/Consecuentes y SOPs de Evento desde esta interfaz unificada.
  </div>
</div>

<div class="stack">

  <!-- ========================================================================
       CARD 1: SELECCI√ìN SOP REGULAR/CONSECUENTE
       ======================================================================== -->
  <div class="card">
    <h2 class="section-title">SOP Regular / Consecuente</h2>
    <p class="section-desc">
      Selecciona el tipo, √°rea, sub√°rea y nivel de limpieza.
    </p>

    <form method="GET" action="{{ url_for('main.sop_panel') }}" id="sopFilterForm">
      <!-- ‚úÖ Mantener valores de SOP evento si existen -->
      {% if evento_tipo_id %}
        <input type="hidden" name="evento_tipo_id" value="{{ evento_tipo_id }}">
      {% endif %}
      {% if caso_id %}
        <input type="hidden" name="caso_id" value="{{ caso_id }}">
      {% endif %}

      <div class="control-grid">
        
        <div class="field">
          <label for="tipo_sop">Tipo SOP</label>
          <select name="tipo_sop" id="tipo_sop">
            <option value="regular" {% if tipo_sop == 'regular' %}selected{% endif %}>Regular</option>
            <option value="consecuente" {% if tipo_sop == 'consecuente' %}selected{% endif %}>Consecuente</option>
          </select>
        </div>

        <div class="field">
          <label for="area_id">√Årea</label>
          <select name="area_id" id="area_id">
            <option value="">‚Äî Selecciona ‚Äî</option>
            {% for a in areas %}
              <option value="{{ a.area_id }}" {% if area_id == a.area_id %}selected{% endif %}>
                {{ a.area_nombre }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label for="subarea_id">Sub√°rea</label>
          <select name="subarea_id" id="subarea_id" {% if not area_id %}disabled{% endif %}>
            <option value="">‚Äî Selecciona ‚Äî</option>
            {% for s in subareas %}
              <option value="{{ s.subarea_id }}" {% if subarea_id == s.subarea_id %}selected{% endif %}>
                {{ s.subarea_nombre }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label for="nivel">Nivel</label>
          <select name="nivel" id="nivel">
            <!-- ‚úÖ Opciones se actualizan din√°micamente seg√∫n tipo_sop -->
            <option value="basica" {% if nivel == 'basica' %}selected{% endif %}>B√°sica</option>
            <option value="media" {% if nivel == 'media' %}selected{% endif %} class="nivel-regular">Media</option>
            <option value="profundo" {% if nivel == 'profundo' %}selected{% endif %} class="nivel-regular">Profundo</option>
            <option value="extraordinario" {% if nivel == 'extraordinario' %}selected{% endif %} class="nivel-regular">Extraordinario</option>
          </select>
        </div>

        <button class="btn btn-blue" type="submit">Cargar</button>
      </div>
    </form>
  </div>

  <!-- ========================================================================
       CARD 2: RESULTADO SOP REGULAR/CONSECUENTE
       ======================================================================== -->
  {% if subarea_id %}
  <div class="card">
    <div class="result-row">
      <div class="stats">

        {% if sop %}
        <div class="pill">SOP: <strong>{{ sop.sop_id }}</strong></div>
        {% else %}
        <div class="pill pill-warn">SOP: <strong>No creado</strong></div>
        {% endif %}

        <div class="pill">Tipo: <strong>{{ tipo_sop|capitalize }}</strong></div>
        <div class="pill">Nivel: <strong>{{ nivel|capitalize }}</strong></div>

        {% if sop and has_nivel %}
        <div class="pill pill-ok">Estado: <strong>Creado</strong></div>
        {% else %}
        <div class="pill pill-warn">Estado: <strong>Sin detalles</strong></div>
        {% endif %}
      </div>

      <div class="right-actions">
        {% if sop and has_fracciones %}
        <a class="btn btn-green"
            href="{{ url_for('main.sop_fracciones_edit', sop_id=sop.sop_id, nivel=nivel) }}">
            Modificar SOP
        </a>
        {% else %}
        <a class="btn btn-green"
            href="{{ url_for('main.sop_crear', subarea_id=subarea_id, nivel=nivel, tipo_sop=tipo_sop) }}">
            Crear SOP
        </a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ========================================================================
       CARD 3: SELECCI√ìN SOP EVENTO
       ======================================================================== -->
  <div class="card">
    <h2 class="section-title">SOP - Evento</h2>
    <p class="section-desc">
      Selecciona el tipo de evento y el caso espec√≠fico. Los eventos no tienen niveles de limpieza.
    </p>
    
    <form method="GET" action="{{ url_for('main.sop_panel') }}" id="sopEventoForm">
      <!-- ‚úÖ Mantener valores de SOP regular si existen -->
      {% if tipo_sop %}
        <input type="hidden" name="tipo_sop" value="{{ tipo_sop }}">
      {% endif %}
      {% if area_id %}
        <input type="hidden" name="area_id" value="{{ area_id }}">
      {% endif %}
      {% if subarea_id %}
        <input type="hidden" name="subarea_id" value="{{ subarea_id }}">
      {% endif %}
      {% if nivel %}
        <input type="hidden" name="nivel" value="{{ nivel }}">
      {% endif %}
      
      <div class="control-grid" style="grid-template-columns: 1fr 1fr auto;">
        
        <div class="field">
          <label for="evento_tipo_id">Tipo de Evento</label>
          <select name="evento_tipo_id" id="evento_tipo_id">
            <option value="">‚Äî Selecciona ‚Äî</option>
            {% for e in eventos %}
              <option value="{{ e.evento_tipo_id }}" 
                      {% if evento_tipo_id == e.evento_tipo_id %}selected{% endif %}>
                {{ e.nombre }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label for="caso_id">Caso</label>
          <select name="caso_id" id="caso_id" {% if not evento_tipo_id %}disabled{% endif %}>
            <option value="">‚Äî Selecciona ‚Äî</option>
            {% for c in casos %}
              <option value="{{ c.caso_id }}" 
                      {% if caso_id == c.caso_id %}selected{% endif %}>
                {{ c.nombre }}
              </option>
            {% endfor %}
          </select>
        </div>

        <button class="btn btn-blue" type="submit">Cargar</button>
      </div>
    </form>
  </div>

  <!-- ========================================================================
       CARD 4: RESULTADO SOP EVENTO
       ======================================================================== -->
  {% if caso_id %}
  <div class="card">
    <div class="result-row">
      <div class="stats">
      <!-- 1) SOP Evento -->
      {% if sop_evento %}
      <div class="pill">SOP Evento: <strong>{{ sop_evento.sop_evento_id }}</strong></div>
      {% else %}
      <div class="pill pill-warn">SOP Evento: <strong>No creado</strong></div>
      {% endif %}

      <!-- 2) Tipo -->
      <div class="pill">Tipo: <strong>
        {% for e in eventos %}
          {% if e.evento_tipo_id == evento_tipo_id %}{{ e.nombre }}{% endif %}
        {% endfor %}
      </strong></div>

      <!-- 3) Caso -->
      <div class="pill">Caso: <strong>
        {% for c in casos %}
          {% if c.caso_id == caso_id %}{{ c.nombre }}{% endif %}
        {% endfor %}
      </strong></div>

      <!-- 4) Estado -->
      {% if sop_evento %}
      <div class="pill pill-ok">Estado: <strong>Creado</strong></div>
      {% else %}
      <div class="pill pill-warn">Estado: <strong>Sin crear</strong></div>
      {% endif %}      
    </div>

      <div class="right-actions">
        {% if sop_evento and has_fracciones_evento %}
        <a class="btn btn-green"
            href="{{ url_for('main.sop_evento_editar', sop_evento_id=sop_evento.sop_evento_id) }}">
            Modificar SOP Evento
        </a>
        {% else %}
        <a class="btn btn-green"
            href="{{ url_for('main.sop_evento_crear', evento_tipo_id=evento_tipo_id, caso_id=caso_id) }}">
            Crear SOP Evento
        </a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

</div>

<script>
  // =====================================================
  // üéØ SISTEMA DE NAVEGACI√ìN MULTINIVEL EN SIDEBAR
  // =====================================================
  
  (function() {
    'use strict';

    // ===== ELEMENTOS DEL DOM =====
    const nav = document.getElementById('sideNav');
    const navHead = document.getElementById('navHead');
    const navContent = document.getElementById('navContent');
    const burger = document.getElementById('navToggle');
    const overlay = document.getElementById('navOverlay');
    const topGuard = document.getElementById('topGuard');

    if (!nav || !navContent) return;

    // ===== CONFIGURACI√ìN DE NIVELES =====
    const NAV_LEVELS = {
      main: {
        level: 0,
        title: 'Menu Principal',
        showBrand: true,
        items: [
          { icon: 'üè†', text: 'Programaci√≥n', url: '{{ url_for("main.home") }}' },
          { icon: 'üìã', text: 'Plantillas', url: '{{ url_for("main.plantillas_panel") }}' },
          { icon: 'üß©', text: 'SOP', url: '{{ url_for("main.sop_panel") }}' },
          { icon: '‚öôÔ∏è', text: 'Cat√°logos', action: 'navigateTo', target: 'catalogos' }
        ]
      },
      catalogos: {
        level: 1,
        title: 'Cat√°logos',
        parent: 'main',
        showBrand: false,
        items: [
          { icon: 'üì¶', text: 'Regulares', action: 'alert', message: 'Pr√≥ximamente disponible' },
          { icon: 'üéØ', text: 'Eventos', action: 'alert', message: 'Pr√≥ximamente disponible' },
          { icon: 'üîó', text: 'Compartidos', action: 'navigateTo', target: 'compartidos' }
        ]
      },
      compartidos: {
        level: 2,
        title: 'Compartidos',
        parent: 'catalogos',
        showBrand: false,
        items: [
          { icon: 'üß™', text: 'Qu√≠micos/Recetas', url: '{{ url_for("main.catalogos_quimicos_recetas") }}' },
          { icon: 'üì¶', text: 'Consumos', url: '{{ url_for("main.catalogos_consumos") }}' }
        ]
      }
    };

    // ===== ESTADO DE NAVEGACI√ìN =====
    let currentLevel = 'main';
    let navStack = ['main'];

    // ===== FUNCIONES DE NAVEGACI√ìN =====
    
    function navigateTo(targetLevel) {
      if (!NAV_LEVELS[targetLevel]) return;

      navContent.classList.add('is-transitioning');
      setTimeout(() => {
        currentLevel = targetLevel;
        navStack.push(targetLevel);
        saveNavState();
        renderNavLevel();
        requestAnimationFrame(() => {
          navContent.classList.remove('is-transitioning');
        });
      }, 150);
    }

    function goBack() {
      if (navStack.length <= 1) return;

      navContent.classList.add('is-transitioning');
      setTimeout(() => {
        navStack.pop();
        currentLevel = navStack[navStack.length - 1];
        saveNavState();
        renderNavLevel();
        requestAnimationFrame(() => {
          navContent.classList.remove('is-transitioning');
        });
      }, 150);
    }

    function renderNavLevel() {
      const levelConfig = NAV_LEVELS[currentLevel];
      if (!levelConfig) return;

      updateNavHeader(levelConfig);

      let html = '';
      levelConfig.items.forEach(item => {
        if (item.url) {
          html += `<a class="side-nav__link" href="${item.url}">${item.icon} ${item.text}</a>`;
        } else if (item.action === 'navigateTo') {
          html += `<button class="side-nav__link" onclick="navSystem.navigateTo('${item.target}')">${item.icon} ${item.text}</button>`;
        } else if (item.action === 'alert') {
          html += `<button class="side-nav__link" onclick="alert('${item.message}')">${item.icon} ${item.text}</button>`;
        }
      });

      if (currentLevel === 'main') {
        html += `
          <div class="side-nav__section">Sesi√≥n</div>
          <form method="POST" action="{{ url_for('main.logout') }}" style="margin:0;">
            <button type="submit" class="side-nav__link">üö™ Salir</button>
          </form>
        `;
      }

      navContent.innerHTML = html;
    }

    function updateNavHeader(levelConfig) {
      navHead.innerHTML = '';

      if (levelConfig.showBrand) {
        navHead.innerHTML = `
          <div class="side-nav__brand">
            <strong>LuxSOP</strong>
            <span>ERP ¬∑ Limpieza</span>
          </div>
          <button class="side-nav__close" id="navClose" aria-label="Cerrar men√∫">‚úï</button>
        `;
      } else {
        navHead.innerHTML = `
          <button class="side-nav__back" id="navBack" aria-label="Volver">‚Üê</button>
          <div class="side-nav__brand">
            <strong>${levelConfig.title}</strong>
          </div>
          <button class="side-nav__close" id="navClose" aria-label="Cerrar men√∫">‚úï</button>
        `;

        const backBtn = document.getElementById('navBack');
        if (backBtn) backBtn.addEventListener('click', goBack);
      }

      const closeBtn = document.getElementById('navClose');
      if (closeBtn) closeBtn.addEventListener('click', closeNav);
    }

    // ===== PERSISTENCIA =====
    
    function saveNavState() {
      sessionStorage.setItem('luxsop_nav_level', currentLevel);
      sessionStorage.setItem('luxsop_nav_stack', JSON.stringify(navStack));
    }

    function restoreNavState() {
      // ‚úÖ Siempre iniciamos en main (ya no restauramos estado previo)
      currentLevel = 'main';
      navStack = ['main'];
      renderNavLevel();
    }

    // ===== ABRIR/CERRAR =====
    
    function openNav() {
      topGuard?.classList.add('is-on');
      requestAnimationFrame(() => {
        overlay.classList.add('is-open');
        nav.classList.add('is-open');
        burger.setAttribute('aria-expanded', 'true');
        overlay.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      });
    }

    function closeNav() {
      nav.classList.remove('is-open');
      overlay.classList.remove('is-open');
      requestAnimationFrame(() => {
        topGuard?.classList.remove('is-on');
      });
      burger.setAttribute('aria-expanded', 'false');
      overlay.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';

      // ‚úÖ RESETEAR AL NIVEL MAIN AL CERRAR
      currentLevel = 'main';
      navStack = ['main'];
      sessionStorage.removeItem('luxsop_nav_level');
      sessionStorage.removeItem('luxsop_nav_stack');
      renderNavLevel();
    }

    // ===== EVENT LISTENERS =====
    
    burger?.addEventListener('click', openNav);
    overlay?.addEventListener('click', closeNav);
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeNav();
    });

    nav.addEventListener('click', (e) => {
      const link = e.target.closest('a');
      if (link) closeNav();
    });

    // ===== INICIALIZACI√ìN =====
    
    window.navSystem = { navigateTo, goBack };
    restoreNavState();

  })();

  // ‚úÖ Filtrar niveles seg√∫n tipo_sop
  (function(){
    var tipoSop = document.getElementById('tipo_sop');
    var nivelSelect = document.getElementById('nivel');
    
    if(!tipoSop || !nivelSelect) return;
    
    function actualizarNiveles() {
      var tipo = tipoSop.value;
      var nivelesRegular = nivelSelect.querySelectorAll('.nivel-regular');
      
      if (tipo === 'consecuente') {
        // Consecuente: solo B√°sica
        nivelesRegular.forEach(function(opt) {
          opt.style.display = 'none';
          opt.disabled = true;
        });
        // Forzar selecci√≥n a B√°sica
        nivelSelect.value = 'basica';
      } else {
        // Regular: todos los niveles
        nivelesRegular.forEach(function(opt) {
          opt.style.display = '';
          opt.disabled = false;
        });
      }
    }
    
    // Ejecutar al cargar
    actualizarNiveles();
    
    // Ejecutar al cambiar tipo
    tipoSop.addEventListener('change', actualizarNiveles);
  })();

  // ‚úÖ UX: recargar al cambiar selectores SOP REGULAR
  (function(){
    var form = document.getElementById('sopFilterForm');
    var tipoSop = document.getElementById('tipo_sop');
    var area = document.getElementById('area_id');
    var sub = document.getElementById('subarea_id');
    var nivel = document.getElementById('nivel');

    if(!form || !area || !nivel) return;

    tipoSop && tipoSop.addEventListener('change', function(){
      // Primero actualizar niveles, luego submit
      setTimeout(function() {
        form.submit();
      }, 50);
    });

    area.addEventListener('change', function(){
      if(sub) sub.value = "";
      form.submit();
    });

    nivel.addEventListener('change', function(){
      form.submit();
    });
  })();

  // ‚úÖ UX: recargar al cambiar selectores SOP EVENTO
  (function(){
    var eventoForm = document.getElementById('sopEventoForm');
    var eventoTipo = document.getElementById('evento_tipo_id');
    var casoSelect = document.getElementById('caso_id');
    
    if(!eventoForm || !eventoTipo) return;
    
    eventoTipo.addEventListener('change', function(){
      // Limpiar caso seleccionado
      if(casoSelect) casoSelect.value = "";
      // Recargar para obtener casos del nuevo tipo
      eventoForm.submit();
    });
  })();

  // ‚úÖ Limpiar par√°metros del otro formulario al hacer submit
  (function(){
    var formRegular = document.getElementById('sopFilterForm');
    var formEvento = document.getElementById('sopEventoForm');
    
    if(!formRegular || !formEvento) return;
    
    // Al enviar form Regular ‚Üí limpiar hidden inputs de Evento
    formRegular.addEventListener('submit', function(){
      var hiddenEvento = formRegular.querySelectorAll('input[name="evento_tipo_id"], input[name="caso_id"]');
      hiddenEvento.forEach(function(input){
        input.remove();
      });
    });
    
    // Al enviar form Evento ‚Üí limpiar hidden inputs de Regular
    formEvento.addEventListener('submit', function(){
      var hiddenRegular = formEvento.querySelectorAll('input[name="tipo_sop"], input[name="area_id"], input[name="subarea_id"], input[name="nivel"]');
      hiddenRegular.forEach(function(input){
        input.remove();
      });
    });
  })();

</script>

</body>
</html>