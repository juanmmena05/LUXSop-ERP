<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Elementos ¬∑ LuxSOP</title>
  <!-- ‚úÖ CSS DEL SIDEBAR (EXTERNO) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
  <style>
    :root {
      --fg: #222;
      --muted: #888;
      --line: #ddd;
      --bg: #f9f9f9;
      --blue: #0d6efd;
      --green: #198754;
      --red: #dc3545;
      --card: #fff;
      --h: 46px;
    }

    * {
      -webkit-tap-highlight-color: transparent !important;
      box-sizing: border-box;
    }

    html { background: var(--bg); }

    body {
      font-family: system-ui, sans-serif;
      color: var(--fg);
      background: var(--bg);
      margin: 0;
      padding: 2rem;
      padding-left: 70px;
      max-width: 1400px;
      margin-inline: auto;
    }

    @media (max-width: 900px) {
      body { padding-left: 2rem; }
    }

    /* ===== Header ===== */
    .head {
      border-bottom: 1px solid var(--line);
      padding-bottom: .85rem;
      margin-bottom: 20px;
    }

    h1 {
      margin: 0;
      font-size: 1.55rem;
      font-weight: 600;
    }

    .sub {
      color: var(--muted);
      font-size: .95rem;
      margin-top: .35rem;
    }

    /* ===== Card Container ===== */
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      padding: 20px;
    }

    /* ===== Filters Section ===== */
    .filters {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--line);
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 180px;
    }

    .filter-label {
      font-size: .85rem;
      font-weight: 600;
      color: #555;
    }

    .filter-select {
      appearance: none;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: .55rem .85rem;
      font-size: .9rem;
      height: var(--h);
      cursor: pointer;
      transition: border-color 0.2s ease;
    }

    .filter-select:hover {
      border-color: var(--blue);
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }

    .btn-clear-filters {
      background: #f8f9fa;
      border: 1px solid var(--line);
      color: #666;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      height: var(--h);
      padding: 0 1rem;
      border-radius: 10px;
      font-size: .9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-clear-filters:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }

    /* ===== Table ===== */
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .table-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--fg);
    }

    .btn {
      border: none;
      border-radius: 12px;
      height: var(--h);
      padding: .55rem 1.1rem;
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      transition: filter 0.2s ease;
    }

    .btn-blue {
      background: var(--blue);
      color: #fff;
    }

    .btn-green {
      background: var(--green);
      color: #fff;
    }

    .btn-sm {
      height: 36px;
      padding: .4rem .8rem;
      font-size: .85rem;
    }

    .btn:hover {
      filter: brightness(.95);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      filter: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    thead {
      background: #f8f9fa;
    }

    th {
      text-align: left;
      padding: 12px 16px;
      font-size: .85rem;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid var(--line);
      white-space: nowrap;
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      font-size: .9rem;
    }

    tbody tr:hover {
      background: #f8f9fa;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .empty-state-text {
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .empty-state-sub {
      font-size: .9rem;
      color: #999;
    }

    /* ===== Badges ===== */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: .8rem;
      font-weight: 500;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-secondary {
      background: #e9ecef;
      color: #495057;
    }

    /* ===== Actions ===== */
    .actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--fg);
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .btn-icon:hover {
      background: #f8f9fa;
      border-color: var(--blue);
      color: var(--blue);
    }

    .btn-icon.btn-delete:hover {
      border-color: var(--red);
      color: var(--red);
      background: #fff5f5;
    }

    /* ===== Pagination ===== */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--line);
    }

    .pagination-info {
      font-size: .9rem;
      color: var(--muted);
      margin: 0 12px;
    }

    .pagination-btn {
      background: #fff;
      border: 1px solid var(--line);
      color: var(--fg);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--blue);
      color: #fff;
      border-color: var(--blue);
    }

    .pagination-btn.active {
      background: var(--blue);
      color: #fff;
      border-color: var(--blue);
    }

    .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* ===== Modal ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1200;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 600px;
      max-height: 85vh;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--line);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--muted);
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: #f8f9fa;
      color: var(--fg);
    }

    .modal-body {
      padding: 24px;
      max-height: calc(85vh - 180px);
      overflow-y: auto;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--line);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* ===== Form ===== */
    .form-group {
      margin-bottom: 18px;
    }

    .form-label {
      display: block;
      font-size: .9rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-label.required::after {
      content: " *";
      color: var(--red);
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: .7rem .85rem;
      border: 1px solid var(--line);
      border-radius: 10px;
      font-size: .95rem;
      transition: border-color 0.2s ease;
      background: #fff;
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }

    .form-input:disabled,
    .form-select:disabled {
      background: #f8f9fa;
      color: var(--muted);
      cursor: not-allowed;
    }

    .form-hint {
      font-size: .85rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .form-error {
      font-size: .85rem;
      color: var(--red);
      margin-top: 6px;
      display: none;
    }

    .form-error.active {
      display: block;
    }

    /* ===== Loading State ===== */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn.is-loading {
      pointer-events: none;
      opacity: 0.7;
    }

  </style>
</head>

<body>
  <!-- ‚úÖ INCLUIR COMPONENTE SIDEBAR -->
  {% include 'components/sidebar_nav.html' %}

  <!-- ===== Contenido Principal ===== -->
  <div class="head">
    <h1>üß© Elementos</h1>
    <div class="sub">Gestiona elementos de limpieza por √°rea y sub√°rea</div>
  </div>

  <div class="card">
    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label class="filter-label" for="filter-area">√Årea</label>
        <select class="filter-select" id="filter-area">
          <option value="">Todas las √°reas</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="filter-subarea">Sub√Årea</label>
        <select class="filter-select" id="filter-subarea" disabled>
          <option value="">Selecciona un √°rea primero</option>
        </select>
      </div>

      <button class="btn-clear-filters" id="btn-clear-filters" style="display: none;">
        ‚úñ Limpiar filtros
      </button>
    </div>

    <!-- Table -->
    <div class="table-header">
      <div class="table-title">
        <span id="elementos-count">Cargando...</span>
      </div>
      <button class="btn btn-blue btn-sm" id="btn-agregar-elemento">
        Agregar Elemento
      </button>
    </div>

    <div id="tabla-container">
      <div class="empty-state">
        <div class="empty-state-icon">‚è≥</div>
        <div class="empty-state-text">Cargando elementos...</div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination-container" style="display: none;">
      <button class="pagination-btn" id="btn-prev-page" disabled>‚Üê</button>
      <span class="pagination-info" id="pagination-info"></span>
      <button class="pagination-btn" id="btn-next-page" disabled>‚Üí</button>
    </div>
  </div>

  <!-- ===== Modal Agregar/Editar Elemento ===== -->
  <div class="modal-overlay" id="modal-elemento">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-elemento-title">Agregar Elemento</h2>
        <button class="modal-close" id="modal-elemento-close">‚úï</button>
      </div>
      <div class="modal-body">
        <form id="form-elemento">
          <input type="hidden" id="elemento-id" name="elemento_id">
          <input type="hidden" id="elemento-mode" value="create">

          <!-- √Årea -->
          <div class="form-group">
            <label class="form-label required" for="elemento-area">√Årea</label>
            <select class="form-select" id="elemento-area" name="area_id" required>
              <option value="">Seleccionar √°rea...</option>
            </select>
          </div>

          <!-- Sub√Årea -->
          <div class="form-group">
            <label class="form-label required" for="elemento-subarea">Sub√Årea</label>
            <select class="form-select" id="elemento-subarea" name="subarea_id" required disabled>
              <option value="">Selecciona un √°rea primero</option>
            </select>
          </div>

          <!-- Grupo/Nombre -->
          <div class="form-group">
            <label class="form-label required" for="elemento-nombre">Grupo/Categor√≠a</label>
            <select class="form-select" id="elemento-nombre" name="nombre" required>
              <option value="">Seleccionar grupo...</option>
            </select>
            <div class="form-hint">Ejemplos: SANITARIO, CESTO, ESPEJO, LAVABO, MUEBLE</div>
          </div>

          <!-- Descripci√≥n -->
          <div class="form-group">
            <label class="form-label required" for="elemento-descripcion">Descripci√≥n</label>
            <select class="form-select" id="elemento-descripcion" name="descripcion" required disabled>
              <option value="">Selecciona un grupo primero</option>
            </select>
            <div class="form-hint">Nombre espec√≠fico del elemento</div>
          </div>

          <!-- ID Preview (solo mostrar al crear) -->
          <div class="form-group" id="elemento-id-preview-group" style="display: none;">
            <label class="form-label">ID del elemento</label>
            <input type="text" class="form-input" id="elemento-id-preview" disabled>
          </div>

          <!-- Cantidad -->
          <div class="form-group">
            <label class="form-label required" for="elemento-cantidad">Cantidad</label>
            <input type="number" class="form-input" id="elemento-cantidad" name="cantidad" min="1" step="1" required>
            <div class="form-hint">N√∫mero entero mayor o igual a 1</div>
          </div>

          <!-- Estatus (solo en edici√≥n) -->
          <div class="form-group" id="elemento-estatus-group" style="display: none;">
            <label class="form-label required" for="elemento-estatus">Estatus</label>
            <select class="form-select" id="elemento-estatus" name="estatus">
              <option value="ACTIVO">ACTIVO</option>
              <option value="INACTIVO">INACTIVO</option>
            </select>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-sm" style="background: #6c757d; color: #fff;" id="modal-elemento-cancel">
          Cancelar
        </button>
        <button class="btn btn-green btn-sm" id="modal-elemento-save">
          Guardar Elemento
        </button>
      </div>
    </div>
  </div>

  <script>
  // =====================================================
  // üéØ SISTEMA DE GESTI√ìN DE ELEMENTOS
  // =====================================================
  
  (function() {
    'use strict';

    // ===== ESTADO GLOBAL =====
    const state = {
      elementos: [],
      catalogos: null,
      currentPage: 1,
      totalPages: 1,
      perPage: 20,
      filters: {
        area_id: '',
        subarea_id: ''
      }
    };

    // ===== ELEMENTOS DEL DOM =====
    const filterArea = document.getElementById('filter-area');
    const filterSubarea = document.getElementById('filter-subarea');
    const btnClearFilters = document.getElementById('btn-clear-filters');
    const btnAgregarElemento = document.getElementById('btn-agregar-elemento');
    const tablaContainer = document.getElementById('tabla-container');
    const elementosCount = document.getElementById('elementos-count');
    const paginationContainer = document.getElementById('pagination-container');
    const paginationInfo = document.getElementById('pagination-info');
    const btnPrevPage = document.getElementById('btn-prev-page');
    const btnNextPage = document.getElementById('btn-next-page');

    // Modal
    const modalElemento = document.getElementById('modal-elemento');
    const modalElementoTitle = document.getElementById('modal-elemento-title');
    const modalElementoClose = document.getElementById('modal-elemento-close');
    const modalElementoCancel = document.getElementById('modal-elemento-cancel');
    const modalElementoSave = document.getElementById('modal-elemento-save');
    const formElemento = document.getElementById('form-elemento');

    // Form fields
    const elementoId = document.getElementById('elemento-id');
    const elementoMode = document.getElementById('elemento-mode');
    const elementoArea = document.getElementById('elemento-area');
    const elementoSubarea = document.getElementById('elemento-subarea');
    const elementoNombre = document.getElementById('elemento-nombre');
    const elementoDescripcion = document.getElementById('elemento-descripcion');
    const elementoIdPreview = document.getElementById('elemento-id-preview');
    const elementoIdPreviewGroup = document.getElementById('elemento-id-preview-group');
    const elementoCantidad = document.getElementById('elemento-cantidad');
    const elementoEstatus = document.getElementById('elemento-estatus');
    const elementoEstatusGroup = document.getElementById('elemento-estatus-group');

    // ===== INICIALIZACI√ìN =====
    async function init() {
      await loadCatalogos();
      await loadElementos();
      setupEventListeners();
    }

    // ===== CARGAR CAT√ÅLOGOS =====
    async function loadCatalogos() {
      try {
        const response = await fetch('/api/elementos/catalogos');
        if (!response.ok) throw new Error('Error al cargar cat√°logos');
        
        state.catalogos = await response.json();
        
        // Poblar filtros
        populateAreaFilters();
        
        // Poblar selects del modal
        populateModalSelects();

      } catch (error) {
        console.error('Error:', error);
        showError('Error al cargar los cat√°logos');
      }
    }

    // ===== POBLAR FILTROS =====
    function populateAreaFilters() {
      if (!state.catalogos) return;

      // Limpiar y poblar √°rea
      filterArea.innerHTML = '<option value="">Todas las √°reas</option>';
      state.catalogos.areas.forEach(area => {
        const option = document.createElement('option');
        option.value = area.area_id;
        option.textContent = area.nombre;
        filterArea.appendChild(option);
      });
    }

    function populateSubareaFilter(areaId) {
      filterSubarea.innerHTML = '<option value="">Todas las sub√°reas</option>';
      filterSubarea.disabled = !areaId;

      if (!areaId || !state.catalogos) return;

      const subareas = state.catalogos.subareas.filter(sa => sa.area_id === areaId);
      subareas.forEach(subarea => {
        const option = document.createElement('option');
        option.value = subarea.subarea_id;
        option.textContent = subarea.nombre;
        filterSubarea.appendChild(option);
      });
    }

    // ===== POBLAR SELECTS DEL MODAL =====
    function populateModalSelects() {
      if (!state.catalogos) return;

      // √Åreas del modal
      elementoArea.innerHTML = '<option value="">Seleccionar √°rea...</option>';
      state.catalogos.areas.forEach(area => {
        const option = document.createElement('option');
        option.value = area.area_id;
        option.textContent = area.nombre;
        elementoArea.appendChild(option);
      });

      // Grupos/Nombres
      elementoNombre.innerHTML = '<option value="">Seleccionar grupo...</option>';
      state.catalogos.grupos.forEach(grupo => {
        const option = document.createElement('option');
        option.value = grupo;
        option.textContent = grupo;
        elementoNombre.appendChild(option);
      });
    }

    // ===== CARGAR ELEMENTOS =====
    async function loadElementos(page = 1) {
      try {
        const params = new URLSearchParams({
          page: page,
          per_page: state.perPage
        });

        if (state.filters.area_id) params.append('area_id', state.filters.area_id);
        if (state.filters.subarea_id) params.append('subarea_id', state.filters.subarea_id);

        const response = await fetch(`/api/elementos?${params}`);
        if (!response.ok) throw new Error('Error al cargar elementos');
        
        const data = await response.json();
        
        state.elementos = data.elementos;
        state.currentPage = data.current_page;
        state.totalPages = data.pages;
        
        renderTabla();
        updatePagination(data);

      } catch (error) {
        console.error('Error:', error);
        showError('Error al cargar los elementos');
      }
    }

    // ===== RENDERIZAR TABLA =====
    function renderTabla() {
      if (state.elementos.length === 0) {
        tablaContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üß©</div>
            <div class="empty-state-text">No hay elementos</div>
            <div class="empty-state-sub">Agrega el primer elemento o ajusta los filtros</div>
          </div>
        `;
        elementosCount.textContent = 'No hay elementos';
        return;
      }

      elementosCount.textContent = `Elementos (${state.elementos.length})`;

      const tabla = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Grupo</th>
              <th>Descripci√≥n</th>
              <th>Sub√Årea</th>
              <th>√Årea</th>
              <th>Cantidad</th>
              <th>Estatus</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${state.elementos.map(elem => `
              <tr>
                <td><code>${elem.elemento_id}</code></td>
                <td><strong>${elem.nombre}</strong></td>
                <td>${elem.descripcion || '‚Äî'}</td>
                <td>${elem.subarea_nombre}</td>
                <td>${elem.area_nombre}</td>
                <td>${elem.cantidad}</td>
                <td>
                  <span class="badge ${elem.estatus === 'ACTIVO' ? 'badge-success' : 'badge-secondary'}">
                    ${elem.estatus}
                  </span>
                </td>
                <td>
                  <div class="actions">
                    <button class="btn-icon" data-action="edit" data-id="${elem.elemento_id}" title="Editar">
                      ‚úèÔ∏è
                    </button>
                    <button class="btn-icon btn-delete" data-action="delete" data-id="${elem.elemento_id}" title="Eliminar">
                      üóëÔ∏è
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      tablaContainer.innerHTML = tabla;
    }

    // ===== ACTUALIZAR PAGINACI√ìN =====
    function updatePagination(data) {
      if (data.pages <= 1) {
        paginationContainer.style.display = 'none';
        return;
      }

      paginationContainer.style.display = 'flex';
      paginationInfo.textContent = `P√°gina ${data.current_page} de ${data.pages}`;
      
      btnPrevPage.disabled = !data.has_prev;
      btnNextPage.disabled = !data.has_next;
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
      // Filtros
      filterArea.addEventListener('change', handleAreaFilterChange);
      filterSubarea.addEventListener('change', handleSubareaFilterChange);
      btnClearFilters.addEventListener('click', clearFilters);

      // Paginaci√≥n
      btnPrevPage.addEventListener('click', () => loadElementos(state.currentPage - 1));
      btnNextPage.addEventListener('click', () => loadElementos(state.currentPage + 1));

      // Modal
      btnAgregarElemento.addEventListener('click', () => openModal('create'));
      modalElementoClose.addEventListener('click', closeModal);
      modalElementoCancel.addEventListener('click', closeModal);
      modalElementoSave.addEventListener('click', saveElemento);
      
      // Click fuera del modal para cerrar
      modalElemento.addEventListener('click', (e) => {
        if (e.target === modalElemento) closeModal();
      });

      // Event delegation para acciones de tabla
      tablaContainer.addEventListener('click', handleTableAction);

      // Cascadas del modal
      elementoArea.addEventListener('change', handleModalAreaChange);
      elementoNombre.addEventListener('change', handleModalNombreChange);
      elementoDescripcion.addEventListener('change', handleModalDescripcionChange);
    }

    // ===== MANEJAR CAMBIO DE FILTRO √ÅREA =====
    function handleAreaFilterChange() {
      const areaId = filterArea.value;
      state.filters.area_id = areaId;
      state.filters.subarea_id = '';
      
      populateSubareaFilter(areaId);
      
      if (areaId) {
        btnClearFilters.style.display = 'inline-flex';
      } else {
        btnClearFilters.style.display = 'none';
      }
      
      state.currentPage = 1;
      loadElementos();
    }

    // ===== MANEJAR CAMBIO DE FILTRO SUB√ÅREA =====
    function handleSubareaFilterChange() {
      state.filters.subarea_id = filterSubarea.value;
      state.currentPage = 1;
      loadElementos();
      
      if (state.filters.subarea_id) {
        btnClearFilters.style.display = 'inline-flex';
      }
    }

    // ===== LIMPIAR FILTROS =====
    function clearFilters() {
      state.filters = { area_id: '', subarea_id: '' };
      filterArea.value = '';
      filterSubarea.value = '';
      filterSubarea.disabled = true;
      btnClearFilters.style.display = 'none';
      state.currentPage = 1;
      loadElementos();
    }

    // ===== MANEJAR ACCIONES DE TABLA =====
    function handleTableAction(e) {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const action = btn.dataset.action;
      const id = btn.dataset.id;

      if (action === 'edit') {
        editElemento(id);
      } else if (action === 'delete') {
        deleteElemento(id);
      }
    }

    // ===== ABRIR MODAL =====
    function openModal(mode, elemento = null) {
      elementoMode.value = mode;
      formElemento.reset();

      if (mode === 'create') {
        modalElementoTitle.textContent = 'Agregar Elemento';
        elementoIdPreviewGroup.style.display = 'none';
        elementoEstatusGroup.style.display = 'none';
        
        // Habilitar todos los campos
        elementoArea.disabled = false;
        elementoSubarea.disabled = true;
        elementoNombre.disabled = false;
        elementoDescripcion.disabled = true;

        // Si hay filtros activos, pre-seleccionarlos
        if (state.filters.area_id) {
          elementoArea.value = state.filters.area_id;
          populateModalSubareas(state.filters.area_id);
          if (state.filters.subarea_id) {
            elementoSubarea.value = state.filters.subarea_id;
          }
        }

      } else if (mode === 'edit') {
        modalElementoTitle.textContent = 'Editar Elemento';
        elementoIdPreviewGroup.style.display = 'none';
        elementoEstatusGroup.style.display = 'block';

        // Poblar datos
        elementoId.value = elemento.elemento_id;
        elementoCantidad.value = elemento.cantidad;
        elementoEstatus.value = elemento.estatus;

        // Deshabilitar campos no editables
        elementoArea.disabled = true;
        elementoSubarea.disabled = true;
        elementoNombre.disabled = true;
        elementoDescripcion.disabled = true;
      }

      modalElemento.classList.add('active');
    }

    // ===== CERRAR MODAL =====
    function closeModal() {
      modalElemento.classList.remove('active');
      formElemento.reset();
    }

    // ===== MANEJAR CAMBIO DE √ÅREA EN MODAL =====
    function handleModalAreaChange() {
      const areaId = elementoArea.value;
      populateModalSubareas(areaId);
    }

    function populateModalSubareas(areaId) {
      elementoSubarea.innerHTML = '<option value="">Seleccionar sub√°rea...</option>';
      elementoSubarea.disabled = !areaId;

      if (!areaId || !state.catalogos) return;

      const subareas = state.catalogos.subareas.filter(sa => sa.area_id === areaId);
      subareas.forEach(subarea => {
        const option = document.createElement('option');
        option.value = subarea.subarea_id;
        option.textContent = subarea.nombre;
        elementoSubarea.appendChild(option);
      });
    }

    // ===== MANEJAR CAMBIO DE NOMBRE/GRUPO EN MODAL =====
    function handleModalNombreChange() {
      const nombre = elementoNombre.value;
      populateModalDescripciones(nombre);
      elementoIdPreview.value = '';
    }

    function populateModalDescripciones(nombre) {
      elementoDescripcion.innerHTML = '<option value="">Seleccionar descripci√≥n...</option>';
      elementoDescripcion.disabled = !nombre;

      if (!nombre || !state.catalogos) return;

      const descripciones = state.catalogos.descripciones_por_grupo[nombre] || [];
      descripciones.forEach(desc => {
        const option = document.createElement('option');
        option.value = desc;
        option.textContent = desc;
        elementoDescripcion.appendChild(option);
      });
    }

    // ===== MANEJAR CAMBIO DE DESCRIPCI√ìN EN MODAL =====
    async function handleModalDescripcionChange() {
      const nombre = elementoNombre.value;
      const descripcion = elementoDescripcion.value;

      if (!nombre || !descripcion) {
        elementoIdPreview.value = '';
        elementoIdPreviewGroup.style.display = 'none';
        return;
      }

      // Obtener next ID
      try {
        const response = await fetch(`/api/elementos/next-id?nombre=${encodeURIComponent(nombre)}&descripcion=${encodeURIComponent(descripcion)}`);
        if (!response.ok) throw new Error('Error al generar ID');
        
        const data = await response.json();
        elementoIdPreview.value = data.next_id;
        elementoIdPreviewGroup.style.display = 'block';

      } catch (error) {
        console.error('Error:', error);
      }
    }

    // ===== GUARDAR ELEMENTO =====
    async function saveElemento() {
      if (!formElemento.checkValidity()) {
        formElemento.reportValidity();
        return;
      }

      const mode = elementoMode.value;
      const button = modalElementoSave;
      
      button.disabled = true;
      button.innerHTML = '<span class="loading"></span> Guardando...';

      try {
        if (mode === 'create') {
          await createElemento();
        } else {
          await updateElemento();
        }
        
        closeModal();
        await loadElementos(state.currentPage);

      } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'Error al guardar el elemento');
      } finally {
        button.disabled = false;
        button.textContent = 'Guardar Elemento';
      }
    }

    // ===== CREAR ELEMENTO =====
    async function createElemento() {
      const data = {
        subarea_id: elementoSubarea.value,
        nombre: elementoNombre.value,
        descripcion: elementoDescripcion.value,
        cantidad: parseInt(elementoCantidad.value)
      };

      const response = await fetch('/api/elementos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Error al crear elemento');
      }
    }

    // ===== ACTUALIZAR ELEMENTO =====
    async function updateElemento() {
      const id = elementoId.value;
      const data = {
        cantidad: parseInt(elementoCantidad.value),
        estatus: elementoEstatus.value
      };

      const response = await fetch(`/api/elementos/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Error al actualizar elemento');
      }
    }

    // ===== EDITAR ELEMENTO =====
    function editElemento(id) {
      const elemento = state.elementos.find(e => e.elemento_id === id);
      if (!elemento) return;
      
      openModal('edit', elemento);
    }

    // ===== ELIMINAR ELEMENTO =====
    async function deleteElemento(id) {
      const elemento = state.elementos.find(e => e.elemento_id === id);
      if (!elemento) return;

      if (!confirm(`¬øEliminar el elemento ${elemento.nombre} - ${elemento.descripcion}?\n\nEsta acci√≥n no se puede deshacer.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/elementos/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Error al eliminar elemento');
        }

        await loadElementos(state.currentPage);

      } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'Error al eliminar el elemento');
      }
    }

    // ===== UTILIDADES =====
    function showError(message) {
      alert(message);
    }

    // ===== INICIAR =====
    init();

  })();
  </script>
</body>
</html>