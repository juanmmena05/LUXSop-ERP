<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SOP Diario ‚Äî {{ persona.nombre }} ({{ fecha.strftime('%Y-%m-%d') }})</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #fafafa;
      --fg: #222;
      --muted: #666;
      --card: #ffffff;
      --line: #ddd;
      --accent: #0d6efd;
      --ok: #198754;
    }
    html, body {
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }
    h1 {
      font-size: 1.4rem;
      margin: .25rem 0 .5rem;
    }
    h2 {
      font-size: 1.1rem;
      margin: 1.5rem 0 .5rem;
    }
    .sub {
      color: var(--muted);
      font-size: .9rem;
    }
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .spacer { flex: 1; }
    .btn {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: .55rem .8rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: .9rem;
    }
    .btn.ok { background: var(--ok); }
    .btn.secondary { background: #6c757d; }
    .btn:hover { filter: brightness(.95); }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
    }
    .accordion { display: grid; gap: 10px; }
    .acc-item {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }
    .acc-head {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 12px 14px;
      cursor: pointer;
      user-select: none;
      background: #f8f9fa;
    }
    .acc-head h3 { margin: 0; font-size: 1rem; }
    .acc-meta { font-size: .85rem; color: var(--muted); }
    .acc-body { display: none; padding: 14px; }
    .acc-item.open .acc-body { display: block; }
    .muted { color: var(--muted); font-size: .85rem; }
    ol.list { margin: .5rem 0 0 1.2rem; padding-left: 0; }
    li { margin-bottom: .6rem; }
    .footer {
      margin: 22px 0 6px;
      color: var(--muted);
      font-size: .85rem;
      text-align: center;
    }
    .tiempo-box {
      background: #f8f9fa;
      font-size: 0.75rem;
      color: var(--muted);
      padding: 4px 10px;
      margin-top: 6px;
      border-left: 3px solid var(--accent);
      border-radius: 6px;
      display: inline-block;
    }
    .section-line { border-top: 1px solid #eee; margin: 10px 0; }
    .metodologia ol {
      margin-left: 1.2rem;
      padding-left: 0;
      font-size: 0.85rem;
      margin-top: 4px;
    }
    .nota-tecnica {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--muted);
      font-style: italic;
    }
    .list li > div strong {
      font-size: 1.1rem;
      color: var(--fg);
      font-weight: 700;
      letter-spacing: 0.3px;
      display: inline-block;
      margin-bottom: 4px;
    }
    .metodologia strong {
      font-size: 1rem !important;
      font-weight: 400 !important;
      letter-spacing: 0.10px;
    }
    .list li {
      border-bottom: none;
      box-shadow: 0 1px 0 0 rgba(0,0,0,0.06);
      padding-bottom: 10px;
      margin-bottom: 12px;
    }
    .list li:last-child { box-shadow: none; }
    table.elementos-tabla {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    table.elementos-tabla th, table.elementos-tabla td {
      border: 1px solid #ddd;
      padding: 4px 4px;
      text-align: center;
      vertical-align: middle;
    }
    table.elementos-tabla th {
      background-color: #f3f3f3;
      font-weight: 600;
    }
    .observacion-critica {
      background-color: #fff3cd;
      border-left: 4px solid #f0ad4e;
      padding: 8px 12px;
      margin: 8px 0 12px 40px;
      border-radius: 6px;
      font-size: 0.9rem;
      color: #5c4400;
      font-style: italic;
      max-width: 85%;
    }
    .no-aplica {
      text-align: center;
      padding: 10px 0;
    }
    hr.separador { border: none; border-top: 1px solid #ddd; margin: 10px 0; }
    .herramientas-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      align-items: center;
      width: max-content; /* üëà clave */
      margin: 0 auto;      /* üëà centra el bloque en la celda */
    }

    .herramienta-box {
      background: #eef2ff;
      padding: 1px 3px;
      border-radius: 4px;
      font-size: 0.65rem;
      text-align: center;
    }

  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:10px">
    <div>
      <h1>[{{ fecha.strftime('%Y-%m-%d') }}]</h1>
      <div class="sub">
        Operario: <strong>{{ persona.nombre }}</strong> ({{ persona.personal_id }})
      </div>
    </div>
    <div class="spacer"></div>
    <div class="row">
      <a class="btn secondary" href="/">‚¨Ö Volver</a>
      <a class="btn ok"
         href="{{ url_for('main.reporte_persona_dia_pdf', fecha=fecha.strftime('%Y-%m-%d'), personal_id=persona.personal_id) }}"
         target="_blank" title="Descargar reporte completo en PDF">
        üì• Descargar SOP
      </a>
    </div>
  </div>

  <div class="card">
    {% if detalles and detalles|length > 0 %}
      <div class="accordion" id="micro-accordion">
        {% for d in detalles %}
          <div class="acc-item" id="micro-{{ loop.index }}">
            <div class="acc-head" data-acc-toggle="micro-{{ loop.index }}">
              <h3>{{ d.subarea }}</h3>
              <span class="acc-meta">({{ d.area }}) ‚Äî Nivel: <strong>{{ d.nivel|capitalize }}</strong></span>
              <div class="spacer"></div>
              <span class="muted">{{ d.sop_codigo if d.sop_codigo else 'N/D' }}</span>
            </div>
            <div class="acc-body">
              {% if d.observacion_critica %}
                <p><strong>‚ö† Observaciones cr√≠ticas:</strong><br>{{ d.observacion_critica }}</p>
                <div class="section-line"></div>
              {% endif %}

              {% if d.fracciones and d.fracciones|length > 0 %}
                <ol class="list">
                  {% for f in d.fracciones %}
                    <li>
                      <div><strong>{{ f.fraccion_nombre }}</strong></div>

                      {% if f.tiempo_min is not none %}
                        <div class="tiempo-box">‚è± Tiempo estimado: {{ f.tiempo_min }} min</div>
                      {% endif %}

                      {% if f.metodologia and f.metodologia.pasos and f.metodologia.pasos|length > 0 %}
                        <div class="section-line"></div>
                        <div class="metodologia">
                          <strong>üßº Metodolog√≠a:</strong>
                          <ol>
                            {% for paso in f.metodologia.pasos %}
                              <li>{{ paso.instruccion }}</li>
                            {% endfor %}
                          </ol>
                        </div>
                      {% endif %}

                      {% if f.tabla and f.tabla.rows and f.tabla.rows|length > 0 %}
                        <div class="section-line"></div>
                        <table class="elementos-tabla">
                          <thead>
                            <tr>
                              {% for h in f.tabla.headers %}
                                <th>{{ h }}</th>
                              {% endfor %}
                            </tr>
                          </thead>
                          <tbody>
                            {% for r in f.tabla.rows %}
                              <tr>
                                {% for c in r %}
                                  <td>
                                    {% if loop.last and c is iterable and c is not string %}
                                      <div class="herramientas-grid">
                                        {% for herramienta in c %}
                                          <div class="herramienta-box">{{ herramienta }}</div>
                                        {% endfor %}
                                      </div>
                                    {% else %}
                                      {{ c }}
                                    {% endif %}
                                  </td>
                                {% endfor %}
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      {% else %}
                        <div class="muted no-aplica"><em>No aplica.</em></div>
                      {% endif %}

                      <hr class="separador">
                      {% if f.observacion_critica %}
                        <div class="nota-tecnica">üìù Nota t√©cnica: {{ f.observacion_critica }}</div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ol>
              {% else %}
                <p class="muted">Sin fracciones para el nivel asignado.</p>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">No hay SOP asignado para este d√≠a.</p>
    {% endif %}
  </div>
  <div class="footer">LuxSOP ERP ‚Äî SOP diario operativo.</div>
</div>
<script>
  document.addEventListener('click', (e) => {
    const t = e.target.closest('[data-acc-toggle]');
    if (!t) return;
    const id = t.getAttribute('data-acc-toggle');
    const item = document.getElementById(id);
    if (!item) return;
    const isOpen = item.classList.contains('open');
    document.querySelectorAll('.acc-item.open').forEach(el => el.classList.remove('open'));
    if (!isOpen) item.classList.add('open');
  });
</script>
</body>
</html>