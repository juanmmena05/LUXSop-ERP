<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SOP Diario ‚Äì {{ persona.nombre }} ({{ fecha.strftime('%Y-%m-%d') }})</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #fafafa;
      --fg: #222;
      --muted: #666;
      --card: #ffffff;
      --line: #ddd;
      --accent: #0d6efd;
      --ok: #198754;
      --green: #198754;
      --purple: #7c3aed;
      --orange: #fd7e14;
    }
    html, body {
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }
    h1 {
      font-size: 1.4rem;
      margin: .25rem 0 .5rem;
    }
    h2 {
      font-size: 1.1rem;
      margin: 1.5rem 0 .5rem;
    }
    .sub {
      color: var(--muted);
      font-size: .9rem;
    }
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .spacer { flex: 1; }
    .btn {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: .55rem .8rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: .9rem;
    }
    .btn.ok { background: var(--ok); }
    .btn.secondary { background: #6c757d; }
    .btn:hover { filter: brightness(.95); }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
    }

    /* Progress bar */
    .progress-section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 16px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .progress-text {
      font-size: .95rem;
      font-weight: 600;
    }
    .progress-bar {
      height: 12px;
      background: #e9ecef;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--green);
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    .accordion { display: grid; gap: 10px; }
    .acc-item {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
      transition: border-color 0.2s;
    }
    .acc-item.is-checked {
      border-color: #bbf7d0;
      background: #f0fdf4;
    }
    .acc-head {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 12px 14px;
      cursor: pointer;
      user-select: none;
      background: #f8f9fa;
    }
    .acc-item.is-checked .acc-head {
      background: #dcfce7;
    }
    .acc-head h3 { margin: 0; font-size: 1rem; }
    .acc-meta { font-size: .85rem; color: var(--muted); }
    .acc-body { display: none; padding: 14px; }
    .acc-item.open .acc-body { display: block; }
    .muted { color: var(--muted); font-size: .85rem; }
    ol.list { margin: .5rem 0 0 1.2rem; padding-left: 0; }
    li { margin-bottom: .6rem; }
    .footer {
      margin: 22px 0 6px;
      color: var(--muted);
      font-size: .85rem;
      text-align: center;
    }
    .tiempo-box {
      background: #f8f9fa;
      font-size: 0.75rem;
      color: var(--muted);
      padding: 4px 10px;
      margin-top: 6px;
      border-left: 3px solid var(--accent);
      border-radius: 6px;
      display: inline-block;
    }
    .section-line { border-top: 1px solid #eee; margin: 10px 0; }
    .metodologia ol {
      margin-left: 1.2rem;
      padding-left: 0;
      font-size: 0.85rem;
      margin-top: 4px;
    }
    .nota-tecnica {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--muted);
      font-style: italic;
    }
    .list li > div strong {
      font-size: 1.1rem;
      color: var(--fg);
      font-weight: 700;
      letter-spacing: 0.3px;
      display: inline-block;
      margin-bottom: 4px;
    }
    .metodologia strong {
      font-size: 1rem !important;
      font-weight: 400 !important;
      letter-spacing: 0.10px;
    }
    .list li {
      border-bottom: none;
      box-shadow: 0 1px 0 0 rgba(0,0,0,0.06);
      padding-bottom: 10px;
      margin-bottom: 12px;
    }
    .list li:last-child { box-shadow: none; }

    /* Tablas */
    .table-scroll {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    table.elementos-tabla {
      width: 100%;
      min-width: 640px;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    table.elementos-tabla th, table.elementos-tabla td {
      border: 1px solid #ddd;
      padding: 4px 4px;
      text-align: center;
      vertical-align: middle;
    }
    table.elementos-tabla th {
      background-color: #f3f3f3;
      font-weight: 600;
    }

    .observacion-critica {
      background-color: #fff3cd;
      border-left: 4px solid #f0ad4e;
      padding: 8px 12px;
      margin: 8px 0 12px 40px;
      border-radius: 6px;
      font-size: 0.9rem;
      color: #5c4400;
      font-style: italic;
      max-width: 85%;
    }
    .no-aplica {
      text-align: center;
      padding: 10px 0;
    }
    hr.separador { border: none; border-top: 1px solid #ddd; margin: 10px 0; }

    .herramientas-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      align-items: center;
      width: max-content;
      margin: 0 auto;
    }
    .herramienta-box {
      background: #eef2ff;
      padding: 1px 3px;
      border-radius: 4px;
      font-size: 0.65rem;
      text-align: center;
    }

    /* Check completado badge en header */
    .check-badge {
      background: #dcfce7;
      color: #166534;
      font-size: .8rem;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* ‚úÖ Badges de tipo tarea */
    .tipo-badge {
      display: inline-block;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }
    .tipo-regular { background: #d1fae5; color: #065f46; }
    .tipo-extraordinario { background: #ede9fe; color: #5b21b6; }
    .tipo-consecuente { background: #dbeafe; color: #1e40af; }
    
    /* ‚úÖ Estilos para tareas fijas y eventos - COLORES SUAVES */
    .acc-item.tipo-inicio {
      border-left: 4px solid #90CAF9;
      background: #F1F8FF;
    }
    .acc-item.tipo-inicio .acc-head {
      background: #E3F2FD;
    }
    .acc-item.tipo-receso {
      border-left: 4px solid #FFD54F;
      background: #FFFEF7;
    }
    .acc-item.tipo-receso .acc-head {
      background: #FFF9E6;
    }
    .acc-item.tipo-limpieza_equipo {
      border-left: 4px solid #81C784;
      background: #F1F8F4;
    }
    .acc-item.tipo-limpieza_equipo .acc-head {
      background: #E8F5E9;
    }
    .acc-item.tipo-evento {
      border-left: 4px solid #FFB74D;
      background: #FFF8F0;
    }
    .acc-item.tipo-evento .acc-head {
      background: #FFF3E0;
    }

    /* Checkbox de completado al final de cada sub√°rea */
    .check-section {
      margin-top: 16px;
      padding-top: 14px;
      border-top: 2px dashed #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .check-section.is-loading {
      opacity: 0.5;
      pointer-events: none;
    }
    .check-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      border: 2px solid var(--line);
      background: #fff;
      color: var(--fg);
      transition: all 0.2s;
    }
    .check-btn:hover {
      border-color: var(--green);
      background: #f0fdf4;
    }
    .check-btn.is-checked {
      background: var(--green);
      border-color: var(--green);
      color: #fff;
    }
    .check-btn.is-checked:hover {
      background: #166534;
      border-color: #166534;
    }
    .check-time {
      font-size: .85rem;
      color: var(--green);
      font-weight: 600;
    }

    /* Responsive m√≥vil */
    @media (max-width: 600px) {
      .wrap {
        max-width: 100%;
        padding: 4px;
      }
      .card {
        padding: 8px;
        border-radius: 10px;
      }
      .row {
        gap: 8px;
      }
      .acc-head {
        flex-wrap: wrap;
      }
      .acc-head h3 {
        width: 100%;
      }
      .acc-meta {
        width: 100%;
      }
      .btn {
        width: 100%;
        text-align: center;
      }
      .observacion-critica {
        margin: 8px 0 12px 0;
        max-width: 100%;
      }
      .herramientas-grid {
        width: 100%;
        justify-content: flex-start;
        margin: 0;
      }
      .check-section {
        flex-direction: column;
        gap: 8px;
      }
      .check-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom: 10px">
    <div>
      <h1>[{{ fecha.strftime('%Y-%m-%d') }}]</h1>
      <div class="sub">
        Operario: <strong>{{ persona.nombre }}</strong> ({{ persona.personal_id }})
      </div>
    </div>
    <div class="spacer"></div>
    <div class="row">
      <a class="btn secondary" href="{{ url_for('main.mi_ruta') }}">‚¨Ö Volver</a>
      <a class="btn ok"
         href="{{ url_for('main.reporte_persona_dia_pdf', fecha=fecha.strftime('%Y-%m-%d'), personal_id=persona.personal_id) }}"
         target="_blank" title="Descargar reporte completo en PDF">
        üì• Descargar SOP
      </a>
    </div>
  </div>

  {% if puede_hacer_check and detalles and detalles|length > 0 %}
  <!-- Progress -->
  <div class="progress-section">
    <div class="progress-header" id="progressHeader">
      <span class="progress-text">Progreso: {{ completadas }}/{{ total_tareas }}</span>
      <span class="progress-text">{{ progreso_pct }}%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" data-width="{{ progreso_pct }}"></div>
    </div>
  </div>
  {% endif %}

  <div class="card">
    {% if detalles and detalles|length > 0 %}
      <div class="accordion" id="micro-accordion">
        {% for d in detalles %}
          {% set is_checked = d.tarea_id in checks_map %}
          {% set check_time = checks_map.get(d.tarea_id, '') %}
          
          <div class="acc-item tipo-{{ d.tipo_tarea|default("sop")|replace("_", "-") }} {% if is_checked %}is-checked{% endif %}" id="micro-{{ loop.index }}" data-tarea-id="{{ d.tarea_id }}">
            <div class="acc-head" data-acc-toggle="micro-{{ loop.index }}">
              <h3>
                {{ d.subarea }}
                
                <!-- ‚úÖ Badge de tipo (solo para SOPs) -->
                {% if d.tipo_tarea == 'sop' %}
                  {% if d.es_adicional %}
                    {% if d.sop_id and '-C' in d.sop_id %}
                      <span class="tipo-badge tipo-consecuente">Consecuente</span>
                    {% else %}
                      <span class="tipo-badge tipo-extraordinario">Extraordinario</span>
                    {% endif %}
                  {% else %}
                    <span class="tipo-badge tipo-regular">Regular</span>
                  {% endif %}
                {% endif %}
              </h3>
              
              <!-- ‚úÖ Solo mostrar √°rea/nivel para SOPs y Eventos -->
              {% if d.tipo_tarea == 'sop' %}
                <span class="acc-meta">({{ d.area }}) ‚Äì Nivel: <strong>{{ d.nivel|capitalize }}</strong></span>
              {% elif d.tipo_tarea == 'evento' %}
                <span class="acc-meta">({{ d.area }})</span>
              {% endif %}
              <div class="spacer"></div>

              {% if is_checked %}
                <span class="check-badge">‚úì {{ check_time }}</span>
              {% endif %}

              <span class="muted">
                {{ d.tiempo_total_min if d.tiempo_total_min is not none else 'N/D' }} min
              </span>
            </div>

            <div class="acc-body">
              {% if d.observacion_critica %}
                <p><strong>‚ö† Observaciones cr√≠ticas:</strong><br>{{ d.observacion_critica }}</p>
                <div class="section-line"></div>
              {% endif %}
              {% if d.fracciones and d.fracciones|length > 0 %}
                <ol class="list">
                  {% for f in d.fracciones %}
                    <li>
                      <div><strong>{{ f.fraccion_nombre }}</strong></div>

                      {% if f.tiempo_min is not none %}
                        <div class="tiempo-box">‚è± Tiempo estimado: {{ f.tiempo_min }} min</div>
                      {% endif %}

                      {% if f.metodologia and f.metodologia.pasos and f.metodologia.pasos|length > 0 %}
                        <div class="section-line"></div>
                        <div class="metodologia">
                          <strong>üßº Metodolog√≠a:</strong>
                          <ol>
                            {% for paso in f.metodologia.pasos %}
                              <li>{{ paso.instruccion if paso.instruccion is defined else paso.descripcion }}</li>
                            {% endfor %}
                          </ol>
                        </div>
                      {% endif %}

                      {% if f.tabla and f.tabla.rows and f.tabla.rows|length > 0 %}
                        <div class="section-line"></div>

                        <div class="table-scroll">
                          <table class="elementos-tabla">
                            <thead>
                              <tr>
                                {% for h in f.tabla.headers %}
                                  <th>{{ h }}</th>
                                {% endfor %}
                              </tr>
                            </thead>
                            <tbody>
                              {% for r in f.tabla.rows %}
                                <tr>
                                  {% for c in r %}
                                    <td>
                                      {% if loop.last and c is iterable and c is not string %}
                                        <div class="herramientas-grid">
                                          {% for herramienta in c %}
                                            <div class="herramienta-box">{{ herramienta }}</div>
                                          {% endfor %}
                                        </div>
                                      {% else %}
                                        {{ c }}
                                      {% endif %}
                                    </td>
                                  {% endfor %}
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      {% else %}
                        <div class="muted no-aplica"><em>No aplica.</em></div>
                      {% endif %}

                      <hr class="separador">
                      {% if f.observacion_critica %}
                        <div class="nota-tecnica">üìù Nota t√©cnica: {{ f.observacion_critica }}</div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ol>
              {% elif d.tipo_tarea == 'sop' %}
                {# Solo mostrar mensaje para SOPs sin fracciones #}
                <p class="muted">Sin fracciones para el nivel asignado.</p>
              {% endif %}
              <!-- CHECK DE COMPLETADO AL FINAL DE CADA SUB√ÅREA -->
              {% if puede_hacer_check %}
                <div class="check-section" data-tarea-id="{{ d.tarea_id }}">
                  <button type="button" 
                          class="check-btn {% if is_checked %}is-checked{% endif %}"
                          data-tarea-id="{{ d.tarea_id }}">
                    {% if is_checked %}
                      ‚úì Completada
                    {% else %}
                      ‚òê Marcar como completada
                    {% endif %}
                  </button>
                  <span class="check-time" data-time-display>
                    {% if is_checked %}{{ check_time }}{% endif %}
                  </span>
                </div>
              {% endif %}

            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">No hay SOP asignado para este d√≠a.</p>
    {% endif %}
  </div>

  <div class="footer">LuxSOP ERP ‚Äì SOP diario operativo.</div>
</div>

<!-- Datos para JS -->
<script id="page-data" type="application/json">
  {
    "puedeHacerCheck": {{ puede_hacer_check|tojson }},
    "totalTareas": {{ total_tareas }},
    "completadas": {{ completadas }}
  }
</script>

<script>
  // Acorde√≥n
  document.addEventListener('click', function(e) {
    var t = e.target.closest('[data-acc-toggle]');
    if (!t) return;
    var id = t.getAttribute('data-acc-toggle');
    var item = document.getElementById(id);
    if (!item) return;
    var isOpen = item.classList.contains('open');
    document.querySelectorAll('.acc-item.open').forEach(function(el) { 
      el.classList.remove('open'); 
    });
    if (!isOpen) item.classList.add('open');
  });

  // Inicializar width del progress bar desde data-attribute
  (function(){
    var fill = document.getElementById('progressFill');
    if (fill && fill.dataset.width) {
      fill.style.width = fill.dataset.width + '%';
    }
  })();

  // Checks
  (function(){
    var pageDataEl = document.getElementById('page-data');
    var pageData = JSON.parse(pageDataEl ? pageDataEl.textContent : '{}');
    
    if (!pageData.puedeHacerCheck) return;

    var totalTareas = pageData.totalTareas || 0;
    var completadas = pageData.completadas || 0;

    function updateProgress() {
      var pct = totalTareas > 0 ? Math.round((completadas / totalTareas) * 100) : 0;
      
      var fill = document.getElementById('progressFill');
      if (fill) fill.style.width = pct + '%';
      
      var header = document.getElementById('progressHeader');
      if (header) {
        header.innerHTML = 
          '<span class="progress-text">Progreso: ' + completadas + '/' + totalTareas + '</span>' +
          '<span class="progress-text">' + pct + '%</span>';
      }
    }

    document.addEventListener('click', function(e) {
      var btn = e.target.closest('.check-btn');
      if (!btn) return;

      var tareaId = btn.dataset.tareaId;
      var section = btn.closest('.check-section');
      var accItem = btn.closest('.acc-item');
      var timeDisplay = section.querySelector('[data-time-display]');
      var isChecked = btn.classList.contains('is-checked');

      // Loading
      section.classList.add('is-loading');

      fetch('/api/tarea/' + tareaId + '/check', {
        method: isChecked ? 'DELETE' : 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(function(response) {
        return response.json().then(function(data) {
          return { ok: response.ok, data: data };
        });
      })
      .then(function(result) {
        if (result.ok) {
          if (isChecked) {
            // Desmarcar
            btn.classList.remove('is-checked');
            btn.innerHTML = '‚òê Marcar como completada';
            timeDisplay.textContent = '';
            accItem.classList.remove('is-checked');
            
            // Quitar badge del header
            var badge = accItem.querySelector('.check-badge');
            if (badge) badge.remove();
            
            completadas--;
          } else {
            // Marcar
            btn.classList.add('is-checked');
            btn.innerHTML = '‚úì Completada';
            timeDisplay.textContent = result.data.checked_at;
            accItem.classList.add('is-checked');
            
            // Agregar badge al header
            var accHead = accItem.querySelector('.acc-head');
            var spacer = accHead.querySelector('.spacer');
            var existingBadge = accHead.querySelector('.check-badge');
            if (!existingBadge && spacer) {
              var badge = document.createElement('span');
              badge.className = 'check-badge';
              badge.innerHTML = '‚úì ' + result.data.checked_at;
              spacer.insertAdjacentElement('afterend', badge);
            }
            
            completadas++;
          }
          updateProgress();
        } else {
          alert(result.data.error || 'Error al procesar');
        }
      })
      .catch(function(err) {
        alert('Error de conexi√≥n');
      })
      .finally(function() {
        section.classList.remove('is-loading');
      });
    });
  })();
</script>
</body>
</html>