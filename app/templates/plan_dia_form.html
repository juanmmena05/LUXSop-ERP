{% set nivel_clases = {
  'basica': 'nivel-basica',
  'media': 'nivel-media',
  'profundo': 'nivel-profundo'
} %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Plan del D√≠a - {{ fecha.strftime('%Y-%m-%d') }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f9f9f9;
      --fg: #222;
      --muted: #666;
      --line: #ddd;
      --accent: #0d6efd;
      --ok: #198754;
      --card: #fff;
    }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--fg); }
    .wrap { display: flex; min-height: 100vh; }
    .sidebar { width: 280px; background: var(--card); padding: 20px; border-right: 1px solid var(--line); position: sticky; top: 0; height: 100vh; overflow-y: auto; }
    .content { flex: 1; padding: 24px; }
    h1 { font-size: 1.2rem; margin-bottom: 1rem; }
    label { display: block; margin-top: 12px; font-size: .85rem; font-weight: 500; }
    select, button { width: 100%; padding: .5rem; margin-top: .25rem; font-size: .9rem; border-radius: 6px; border: 1px solid var(--line); }
    button { background: var(--ok); color: white; border: none; cursor: pointer; margin-top: 1rem; }
    button:hover { filter: brightness(.95); }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .top-bar a { background: var(--accent); color: #fff; padding: .5rem .75rem; text-decoration: none; border-radius: 8px; font-size: .85rem; }
    .filter-bar { margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; }
    .card { border: 1px solid var(--line); background: #fff; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; }
    .card h2 { margin: 0 0 .5rem; font-size: 1rem; border-bottom: 1px solid #eee; padding-bottom: .4rem; display: flex; justify-content: space-between; align-items: center; }
    .card h2 .persona-nombre { flex: 1; }
    .card h2 .tiempo-total { font-weight: normal; font-size: 0.85rem; color: var(--muted); }
    .card h2 .tiempo-total strong { color: var(--ok); font-weight: 600; }
    .asig-item { padding: .6rem .8rem; border: 1px solid #eee; border-radius: 8px; background: #fefefe; margin-bottom: .5rem; display: flex; justify-content: space-between; align-items: center; }
    .asig-item small { font-size: .8rem; color: var(--muted); }
    .asig-meta { font-size: .85rem; flex: 1; }
    .asig-item form { margin: 0; }
    .btn-delete { background: transparent; border: none; color: #dc3545; cursor: pointer; font-size: 1rem; padding: .25rem .5rem; }

    /* sub√°reas ocupadas en el select */
    #subarea-select option.ocupada { background-color: #f1f1f1; color: #888; }
    #subarea-select option.ocupada:disabled { opacity: 0.8; }

    /* badges de nivel */
    .nivel-badge { padding: 2px 6px; border-radius: 4px; font-size: .7rem; color: white; margin-left: 8px; }
    .nivel-basica { background: #adb5bd; }
    .nivel-media { background: #6c757d; }
    .nivel-profundo { background: #343a40; }

    /* ===== Drag & Drop ===== */
    .tareas-lista { min-height: 20px; }
    .asig-item { cursor: grab; transition: transform 0.15s, box-shadow 0.15s, background 0.15s; }
    .asig-item:active { cursor: grabbing; }
    .asig-item.dragging { opacity: 0.5; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); background: #f0f7ff; }
    .asig-item.drag-over { border-top: 3px solid var(--accent); margin-top: -3px; }
    .drag-handle { cursor: grab; padding: 0 8px; color: #aaa; font-size: 1.1rem; }
    .drag-handle:hover { color: #666; }

    /* ===== Drawer (‚ò∞) ===== */
    .burger{
      position:fixed; left:14px; top:14px; z-index:1001;
      width:40px; height:40px; border-radius:12px;
      border:1px solid var(--line); background:#fff; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      font-size:18px; line-height:1;
    }
    .drawer-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; z-index:1000; }
    .drawer{
      position:fixed; left:0; top:0; bottom:0; width:280px;
      background:#fff; border-right:1px solid var(--line);
      transform:translateX(-105%); transition:transform .2s ease;
      z-index:1002; padding:14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
      overflow:auto;
    }
    .drawer.open{ transform:translateX(0); }
    .drawer-backdrop.open{ display:block; }
    .drawer h3{ margin:6px 0 10px; font-size:1rem; }
    .drawer a{
      display:flex; align-items:center; gap:10px;
      padding:.55rem .7rem; border-radius:10px;
      text-decoration:none; color:var(--fg);
      border:1px solid transparent;
    }
    .drawer a:hover{ background:#f6f6f6; border-color:#eee; }
    .drawer .muted{ color:var(--muted); font-size:.8rem; margin-top:6px; }
  </style>
</head>
<body>

{% if not hide_nav %}
  <button class="burger" id="burger" aria-label="Abrir men√∫">‚ò∞</button>
  <div class="drawer-backdrop" id="backdrop"></div>
  <aside class="drawer" id="drawer" aria-label="Men√∫">
    <h3>LuxSOP</h3>
    <a href="{{ url_for('main.home') }}">üìÖ Programaci√≥n</a>
    <a href="{{ url_for('main.plantillas_panel') }}">üóÇÔ∏è Plantillas</a>
    <div class="muted">Atajos de navegaci√≥n.</div>
  </aside>
{% endif %}

<div class="wrap">
  <div class="sidebar">
    <h1>Agregar Tarea</h1>
    <form method="post" action="{{ url_for('main.plan_dia_asignar', fecha=fecha.strftime('%Y-%m-%d')) }}">
      <label>Personal</label>
      <select name="personal_id" id="personal-select" required>
        <option value="" disabled selected>Seleccionar personal</option>
        {% for p in personal_list %}
          <option value="{{ p.personal_id }}">{{ p.nombre }}</option>
        {% endfor %}
      </select>

      <label>√Årea</label>
      <select name="area_id" id="area-select" required>
        <option value="" disabled selected>Seleccionar √°rea</option>
        {% for a in areas_list %}
          <option value="{{ a.area_id }}">{{ a.area_nombre }}</option>
        {% endfor %}
      </select>

      <label>Sub√°rea</label>
      <select name="subarea_id" id="subarea-select" required>
        <option value="" disabled selected>Seleccionar sub√°rea</option>
        {% for s in subareas_list %}
          {% if s.subarea_id in asignadas_ids %}
            <option value="{{ s.subarea_id }}" disabled class="ocupada">{{ s.subarea_nombre }}</option>
          {% else %}
            <option value="{{ s.subarea_id }}">{{ s.subarea_nombre }}</option>
          {% endif %}
        {% endfor %}
      </select>

      <label>Nivel de limpieza</label>
      <select name="nivel_limpieza_asignado" required>
        <option value="" disabled selected>Seleccionar nivel</option>
        <option value="basica">B√°sica</option>
        <option value="media">Media</option>
        <option value="profundo">Profundo</option>
      </select>

      <button type="submit">Agregar tarea</button>
    </form>
  </div>

  <div class="content">
    <div class="top-bar">
      <h1>Asignaciones del {{ fecha.strftime('%Y-%m-%d') }}</h1>
      <a href="{{ url_for('main.home') }}">Volver al inicio</a>
    </div>

    <div class="filter-bar">
      <label for="filtro-persona">Filtrar por persona:</label>
      <select id="filtro-persona">
        <option value="all">Mostrar todos</option>
        {% for persona_id, grupo in tareas_por_persona.items() %}
          <option value="persona-{{ persona_id }}">{{ grupo.persona.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    {% set etiquetas = {'basica':'B√°sica','media':'Media','profundo':'Profundo'} %}

    {% for persona_id, grupo in tareas_por_persona.items() %}
      <div class="card persona-card" data-persona="persona-{{ persona_id }}">
        <h2>
          <span class="persona-nombre">{{ grupo.persona.nombre }}</span>
          <span class="tiempo-total">Total: <strong>{{ tiempo_total_por_persona.get(persona_id, 0) }} min</strong></span>
        </h2>
        <div class="tareas-lista" data-persona-id="{{ persona_id }}">
          {% for t in grupo.subtareas %}
            <div class="asig-item" draggable="true" data-tarea-id="{{ t.tarea_id }}">
              <span class="drag-handle">‚ãÆ‚ãÆ</span>
              <div class="asig-meta">
                <strong>{{ t.area.area_nombre if t.area else t.area_id }}</strong> ‚Äî {{ t.subarea.subarea_nombre if t.subarea else t.subarea_id }}
                <span class="nivel-badge {{ nivel_clases.get(t.nivel_limpieza_asignado|lower, 'nivel-basica') }}">
                  {{ etiquetas.get(t.nivel_limpieza_asignado, t.nivel_limpieza_asignado|capitalize) }}
                </span>
                <br><small>{{ tiempos_por_tarea.get(t.tarea_id, 0)|round(1) }} min</small>
              </div>
              <form method="post" action="{{ url_for('main.borrar_tarea', fecha=fecha.strftime('%Y-%m-%d'), tarea_id=t.tarea_id) }}">
                <button class="btn-delete" title="Eliminar" onclick="return confirm('¬øBorrar esta tarea?');">‚úñ</button>
              </form>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<script>
  // --- Filtrado din√°mico de sub√°reas seg√∫n √°rea seleccionada (respeta ocupadas del d√≠a) ---
  document.getElementById('area-select').addEventListener('change', function () {
    const fechaActual = "{{ fecha.strftime('%Y-%m-%d') }}";
    fetch('{{ url_for("main.subareas_por_area", area_id="__ID__") }}'.replace('__ID__', this.value) + '?fecha=' + fechaActual)
      .then(response => response.json())
      .then(data => {
        const subareaSelect = document.getElementById('subarea-select');
        subareaSelect.innerHTML = '<option value="" disabled selected>Seleccionar sub√°rea</option>';
        data.forEach(sub => {
          const opt = document.createElement('option');
          opt.value = sub.id;
          opt.textContent = sub.nombre;
          if (sub.ocupada) {
            opt.disabled = true;
            opt.classList.add('ocupada');
          }
          subareaSelect.appendChild(opt);
        });
      });
  });

  // --- Filtro por persona ---
  document.getElementById('filtro-persona').addEventListener('change', function () {
    const selected = this.value;
    document.querySelectorAll('.persona-card').forEach(card => {
      card.style.display = (selected === 'all' || card.dataset.persona === selected) ? '' : 'none';
    });
  });

  // üîÑ Resetear selects despu√©s de enviar la tarea
  const form = document.querySelector('.sidebar form');
  form.addEventListener('submit', function() {
    setTimeout(() => form.reset(), 100);
  });

  // ===== DRAG & DROP =====
  document.querySelectorAll('.tareas-lista').forEach(lista => {
    let draggedItem = null;

    lista.addEventListener('dragstart', (e) => {
      if (e.target.classList.contains('asig-item')) {
        draggedItem = e.target;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      }
    });

    lista.addEventListener('dragend', (e) => {
      if (e.target.classList.contains('asig-item')) {
        e.target.classList.remove('dragging');
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        
        // Guardar nuevo orden
        guardarOrden(lista);
      }
    });

    lista.addEventListener('dragover', (e) => {
      e.preventDefault();
      const afterElement = getDragAfterElement(lista, e.clientY);
      const dragging = lista.querySelector('.dragging');
      
      // Remover clase drag-over de todos
      lista.querySelectorAll('.asig-item').forEach(item => item.classList.remove('drag-over'));
      
      if (afterElement == null) {
        lista.appendChild(dragging);
      } else {
        afterElement.classList.add('drag-over');
        lista.insertBefore(dragging, afterElement);
      }
    });

    lista.addEventListener('dragleave', (e) => {
      if (e.target.classList.contains('asig-item')) {
        e.target.classList.remove('drag-over');
      }
    });
  });

  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.asig-item:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function guardarOrden(lista) {
    const items = lista.querySelectorAll('.asig-item');
    const orden = [];
    
    items.forEach((item, index) => {
      orden.push({
        tarea_id: parseInt(item.dataset.tareaId),
        orden: index
      });
    });

    fetch('{{ url_for("main.reordenar_tareas") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ orden: orden })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        console.log('Orden guardado');
      }
    })
    .catch(error => {
      console.error('Error al guardar orden:', error);
    });
  }
</script>

{% if not hide_nav %}
<script>
  (function(){
    const burger=document.getElementById('burger');
    const drawer=document.getElementById('drawer');
    const backdrop=document.getElementById('backdrop');
    function open(){ drawer.classList.add('open'); backdrop.classList.add('open'); }
    function close(){ drawer.classList.remove('open'); backdrop.classList.remove('open'); }
    burger && burger.addEventListener('click', open);
    backdrop && backdrop.addEventListener('click', close);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
  })();
</script>
{% endif %}

</body>
</html>