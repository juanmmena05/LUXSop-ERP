{% set nivel_clases = {
  'basica': 'nivel-basica',
  'media': 'nivel-media',
  'profunda': 'nivel-profunda'
} %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Plan del D√≠a - {{ fecha.strftime('%Y-%m-%d') }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f9f9f9;
      --fg: #222;
      --muted: #666;
      --line: #ddd;
      --accent: #0d6efd;
      --ok: #198754;
      --card: #fff;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    .wrap {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 280px;
      background: var(--card);
      padding: 20px;
      border-right: 1px solid var(--line);
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    .content {
      flex: 1;
      padding: 24px;
    }
    h1 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-top: 12px;
      font-size: .85rem;
      font-weight: 500;
    }
    select, button {
      width: 100%;
      padding: .5rem;
      margin-top: .25rem;
      font-size: .9rem;
      border-radius: 6px;
      border: 1px solid var(--line);
    }
    button {
      background: var(--ok);
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:hover {
      filter: brightness(.95);
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .top-bar a {
      background: var(--accent);
      color: #fff;
      padding: .5rem .75rem;
      text-decoration: none;
      border-radius: 8px;
      font-size: .85rem;
    }
    .filter-bar {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .card {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .card h2 {
      margin: 0 0 .5rem;
      font-size: 1rem;
      border-bottom: 1px solid #eee;
      padding-bottom: .4rem;
    }
    .asig-item {
      padding: .6rem .8rem;
      border: 1px solid #eee;
      border-radius: 8px;
      background: #fefefe;
      margin-bottom: .5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .asig-item small {
      font-size: .8rem;
      color: var(--muted);
    }
    .asig-meta {
      font-size: .85rem;
    }
    .asig-item form {
      margin: 0;
    }
    .btn-delete {
      background: transparent;
      border: none;
      color: #dc3545;
      cursor: pointer;
      font-size: 1rem;
      padding: .25rem .5rem;
    }

    /* ==== Sub√°reas asignadas (sombreado visual sin texto extra) ==== */
    #subarea-select option.ocupada {
      background-color: #f1f1f1;
      color: #888;
    }
    #subarea-select option.ocupada:disabled {
      opacity: 0.8;
    }

    .nivel-badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: .7rem;
      color: white;
      margin-left: 8px;
    }

    .nivel-basica { background: #adb5bd; }
    .nivel-media { background: #6c757d; }
    .nivel-profunda { background: #343a40; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="sidebar">
    <h1>Agregar Tarea</h1>
    <form method="post">
      <label>Personal</label>
      <select name="personal_id" id="personal-select" required>
        <option value="" disabled selected>Seleccionar personal</option>
        {% for p in personal_list %}
          <option value="{{ p.personal_id }}">{{ p.nombre }}</option>
        {% endfor %}
      </select>

      <label>√Årea</label>
      <select name="area_id" id="area-select" required>
        <option value="" disabled selected>Seleccionar √°rea</option>
        {% for a in areas_list %}
          <option value="{{ a.area_id }}">{{ a.area_nombre }}</option>
        {% endfor %}
      </select>

      <label>Sub√°rea</label>
      <select name="subarea_id" id="subarea-select" required>
        <option value="" disabled selected>Seleccionar sub√°rea</option>
        {% for s in subareas_list %}
          {% if s.subarea_id in asignadas_ids %}
            <option value="{{ s.subarea_id }}" disabled class="ocupada">{{ s.subarea_nombre }}</option>
          {% else %}
            <option value="{{ s.subarea_id }}">{{ s.subarea_nombre }}</option>
          {% endif %}
        {% endfor %}
      </select>

      <label>Nivel de limpieza</label>
      <select name="nivel_limpieza_asignado" required>
        <option value="" disabled selected>Seleccionar nivel</option>
        <option value="basica">B√°sica</option>
        <option value="media">Media</option>
        <option value="profunda">Profunda</option>
      </select>

      <button type="submit">Agregar tarea</button>
    </form>
  </div>

  <div class="content">
    <div class="top-bar">
      <h1>Asignaciones del {{ fecha.strftime('%Y-%m-%d') }}</h1>
      <a href="/">Volver al inicio</a>
    </div>

    <div class="filter-bar">
      <label for="filtro-persona">Filtrar por persona:</label>
      <select id="filtro-persona">
        <option value="all">Mostrar todos</option>
        {% for persona_id, grupo in tareas_por_persona.items() %}
          <option value="persona-{{ persona_id }}">{{ grupo.persona.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    {% for persona_id, grupo in tareas_por_persona.items() %}
      <div class="card persona-card" data-persona="persona-{{ persona_id }}">
        <h2>{{ grupo.persona.nombre }}</h2>
        {% for t in grupo.subtareas %}
          <div class="asig-item">
            <div class="asig-meta">
              <strong>{{ t.area.area_nombre }}</strong> ‚Äî {{ t.subarea.subarea_nombre }}
              <span class="nivel-badge {{ nivel_clases[t.nivel_limpieza_asignado|lower] }}">
                {{ t.nivel_limpieza_asignado|capitalize }}
              </span>
              <br><small>{{ tiempos_por_tarea[t.tarea_id]|round(1) }} min</small>
            </div>
            <form method="post" action="/plan/{{ fecha }}/borrar/{{ t.tarea_id }}">
              <button class="btn-delete" title="Eliminar">‚úñ</button>
            </form>
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>
</div>

<script>
  // --- Filtrado din√°mico de sub√°reas seg√∫n √°rea seleccionada ---
  document.getElementById('area-select').addEventListener('change', function () {
    const fechaActual = "{{ fecha.strftime('%Y-%m-%d') }}";
    fetch('/subareas_por_area/' + this.value + '?fecha=' + fechaActual)
      .then(response => response.json())
      .then(data => {
        const subareaSelect = document.getElementById('subarea-select');
        subareaSelect.innerHTML = '<option value="" disabled selected>Seleccionar sub√°rea</option>';
        data.forEach(sub => {
          const opt = document.createElement('option');
          opt.value = sub.id;
          opt.textContent = sub.nombre; // sin texto (Asignada)
          if (sub.ocupada) {
            opt.disabled = true;
            opt.classList.add('ocupada');
          }
          subareaSelect.appendChild(opt);
        });
      });
  });

  // --- Filtro por persona ---
  document.getElementById('filtro-persona').addEventListener('change', function () {
    const selected = this.value;
    document.querySelectorAll('.persona-card').forEach(card => {
      card.style.display = (selected === 'all' || card.dataset.persona === selected) ? '' : 'none';
    });
  });

  // üîÑ Resetear selects despu√©s de enviar la tarea
  const form = document.querySelector('.sidebar form');
  form.addEventListener('submit', function() {
    setTimeout(() => form.reset(), 100);
  });
</script>
</body>
</html>
